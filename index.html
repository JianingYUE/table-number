<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Interactive 2D Table Map</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff; --good:#38d39f; --warn:#ffb86b; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}

    /* Header & toolbar */
    header{position:sticky;top:0;z-index:6;background:rgba(13,17,23,.92);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #202632;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.6rem .9rem}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;width:100%}
    .toolbar input[type="text"]{min-width:230px}
    .btn, input[type="file"]::file-selector-button, .chip{border:1px solid #303845;background:#12161b;color:var(--text);padding:.48rem .7rem;border-radius:.8rem;cursor:pointer}
    .btn:hover{border-color:#3a4556}
    .btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
    .btn.ghost{background:transparent}
    .btn.warn{background:#312312;border-color:#5a3b13;color:#ffcc88}
    input[type="text"], textarea, select{background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.55rem .6rem;outline:none}
    textarea{min-height:84px;resize:vertical}

    /* Layout */
    .wrap{display:grid;grid-template-columns: 1fr 360px;gap:0;border-top:1px solid #161b22;min-height:calc(100vh - 56px)}
    .panel{border-left:1px solid #202632;background:#0d1117;position:relative}

    /* Map area */
    #stage{position:relative;overflow:auto;background:#0b0e13}
    .board{position:relative;margin:12px;border:1px solid #202632;border-radius:16px;min-height:72vh;background:#0c1016;background-size:contain;background-repeat:no-repeat;background-position:center}
    #grid{position:absolute;inset:0;pointer-events:none;background-image: radial-gradient(circle at 1px 1px,#1a2230 1px,transparent 0);background-size:20px 20px;opacity:.35}

    .table-marker{position:absolute;min-width:52px;min-height:52px;display:flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:14px;border:1px solid #2a3240;background:#10151c;box-shadow:0 4px 16px rgba(0,0,0,.35);cursor:pointer;user-select:none;transition:transform .15s ease, box-shadow .15s ease, border-color .2s}
    .table-marker:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.45)}
    .table-marker.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,166,255,.25)}
    .table-badge{font-weight:700;border-radius:10px;padding:.1rem .45rem;margin-right:.4rem;background:#152032;border:1px solid #243042}
    .marker-name{font-weight:600;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pulse{box-shadow:0 0 0 2px rgba(56,211,159,.2),0 0 0 6px rgba(56,211,159,.08)}
    .table-marker.dragging .drag-handle{display:block}
    .drag-handle{position:absolute;inset:-6px;border:2px dashed #304055;border-radius:16px;display:none}

    /* Side editor */
    .panel h3{margin:16px;font-size:16px}
    .form{display:flex;flex-direction:column;gap:.6rem;padding:0 16px 16px}
    .form .row{display:grid;grid-template-columns:1fr;gap:.5rem}
    .photo{width:100%;aspect-ratio: 4/3; background:#0f1318;border:1px dashed #344055;border-radius:12px;display:grid;place-items:center;overflow:hidden}
    .photo img{width:100%;height:100%;object-fit:cover}

    .items{display:flex;flex-wrap:wrap;gap:.4rem}
    .chip{display:inline-flex;gap:.35rem;align-items:center}
    .chip .x{font-weight:700;opacity:.7}
    .muted{color:var(--muted)}

    .list{max-height:220px;overflow:auto;border-top:1px solid #202632;padding:8px 16px}
    .list .match{padding:6px 8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;border:1px solid #243042;margin-bottom:6px}

    .foot{position:absolute;bottom:0;left:0;right:0;padding:10px 16px;border-top:1px solid #202632;display:flex;gap:.5rem}
    .foot .sp{flex:1}

    .hint{padding:10px 16px;color:#a6b2c0;border-top:1px solid #202632}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;background:#12161b;padding:.1rem .35rem;border-radius:6px;border:1px solid #202632}

    /* Mobile enhancements */
    .mobile-toggle{display:none}
    @media (max-width: 900px){
      .wrap{grid-template-columns:1fr}
      #stage{height:calc(100vh - 56px)}
      .board{min-height:60vh;margin:8px}
      .panel{position:fixed;left:0;right:0;bottom:0;height:60vh;border-left:none;border-top:1px solid #202632;border-radius:16px 16px 0 0;transform:translateY(100%);transition:transform .25s ease;z-index:7}
      .panel.open{transform:translateY(0)}
      .foot{padding-bottom:calc(10px + env(safe-area-inset-bottom))}
      .toolbar{overflow:auto;white-space:nowrap;width:100%}
      .toolbar > *{flex:0 0 auto}
      .toolbar input[type="text"]{min-width:180px}
      .table-marker{min-width:56px;min-height:56px}
      .marker-name{max-width:110px}
      .mobile-toggle{display:block;position:fixed;right:12px;bottom:12px;z-index:8}
    }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <label class="btn ghost">Upload Floorplan<input id="bgFile" type="file" accept="image/*" hidden></label>
      <button id="addTableBtn" class="btn">Add Table</button>
      <button id="toggleEditBtn" class="btn warn" title="Drag markers to reposition">Layout Mode: OFF</button>
      <input id="search" type="text" placeholder="Search items/table/notes… (Enter to focus)" />
      <button id="clearSearch" class="btn ghost">Clear</button>
      <button id="exportBtn" class="btn ghost">Export</button>
      <label class="btn ghost">Import<input id="importFile" type="file" accept="application/json" hidden></label>
      <button id="resetBtn" class="btn ghost" title="Reset all data (keep background)">Reset</button>
    </div>
  </header>

  <div class="wrap">
    <main id="stage">
      <div id="board" class="board">
        <div id="grid"></div>
      </div>
    </main>

    <aside class="panel" id="editor">
      <h3>Table Info</h3>
      <div class="form">
        <div class="row"><label>Table No / Name<input id="f-name" type="text" placeholder="e.g. 12 Left or Private Room A"/></label></div>
        <div class="row"><label>Notes<textarea id="f-notes" placeholder="Internal notes, special requirements, etc"></textarea></label></div>
        <div class="row">
          <label>Items (press Enter to add)<input id="f-itemInput" type="text" placeholder="e.g. Birthday cake, Camera, Thermos" /></label>
          <div id="f-items" class="items muted">None</div>
        </div>
        <div class="row">
          <div class="photo" id="photoBox"><span class="muted">No Photo</span></div>
          <label class="btn ghost" style="width:max-content; margin-top:.4rem">Update Photo<input id="f-photo" type="file" accept="image/*" hidden></label>
        </div>
      </div>
      <div class="hint">Tip: In <span class="kbd">Layout Mode</span> you can drag markers. Double-click a marker to quickly edit.</div>
      <div class="foot">
        <button id="saveBtn" class="btn primary">Save</button>
        <button id="deleteBtn" class="btn" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">Delete Table</button>
        <div class="sp"></div>
        <button id="closeBtn" class="btn ghost">Close</button>
      </div>

      <div class="list" id="resultList"></div>
    </aside>
  </div>

  <button id="togglePanel" class="btn primary mobile-toggle" aria-controls="editor" aria-expanded="false">Edit</button>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const board = $('#board');
  const editor = $('#editor');
  const togglePanelBtn = $('#togglePanel');
  const stateKey = 'tableMapState.v2'; // v2: split photo storage to avoid quota issues
  const bgKey = 'tableMapBG.v1';
  let data = load() || seed();
  let selectedId = null;
  let editMode = false;

  const isMobile = () => window.matchMedia('(max-width: 900px)').matches;

  // ----- init -----
  renderBackground();
  renderAll();
  bindToolbar();
  bindEditor();

  function uid(){return 't' + Math.random().toString(36).slice(2,9)}

  // Generate 1–88, exclude any number containing 4 or 7 in either digit; create Left/Right for each
  function seed(){
    const tables = [];
    const startX = 64;      // left padding (slightly tighter for mobile)
    const startY = 64;      // top padding
    const cellW  = 128;     // horizontal spacing between numbers (not L/R)
    const cellH  = 104;     // vertical spacing
    const cols   = 8;       // numbers per row

    const isValid = (n)=> !/[47]/.test(String(n).padStart(2,'0'));

    let index = 0;
    for(let n=1; n<=88; n++){
      if(!isValid(n)) continue;
      const row = Math.floor(index / cols);
      const col = index % cols;
      const baseX = startX + col*cellW;
      const baseY = startY + row*cellH;
      tables.push({id:uid(), x:baseX-26, y:baseY, name:`${n} Left`, notes:'', items:[], photo:null});
      tables.push({id:uid(), x:baseX+26, y:baseY, name:`${n} Right`, notes:'', items:[], photo:null});
      index++;
    }
    return { tables };
  }

  // ----- persistence (split photos) -----
  function save(){
    try{
      const slim = { tables: data.tables.map(t=>{
        if(t.photo){ try{ localStorage.setItem(`photo:${t.id}`, t.photo); }catch(e){} }
        const {photo, ...rest} = t;
        return rest;
      })};
      localStorage.setItem(stateKey, JSON.stringify(slim));
      return true;
    }catch(e){
      console.error('Save failed', e);
      const msg = /quota|NS_ERROR_DOM_QUOTA_REACHED|NotAllowedError/i.test(String(e))
        ? 'Save failed: storage is blocked or full (Private/Incognito mode on iOS may block storage). Try turning off Private Browsing, compressing photos, or clearing old data (Export first).'
        : 'Save failed due to an unexpected error.';
      alert(msg);
      return false;
    }
  }
  function load(){
    try{
      const raw = localStorage.getItem(stateKey);
      if(!raw) return null;
      const slim = JSON.parse(raw);
      const tables = (slim.tables||[]).map(t=>{
        const photo = localStorage.getItem(`photo:${t.id}`) || null;
        return {...t, photo};
      });
      return {tables};
    }catch(e){ console.error('Load failed', e); return null }
  }

  function setBackground(dataUrl){
    if(dataUrl){ localStorage.setItem(bgKey, dataUrl); board.style.backgroundImage = `url(${dataUrl})`; }
  }
  function renderBackground(){
    const bg = localStorage.getItem(bgKey);
    if(bg){ board.style.backgroundImage = `url(${bg})` }
  }

  // ----- render markers -----
  function renderAll(){
    board.querySelectorAll('.table-marker').forEach(n=>n.remove());
    data.tables.forEach(t=> board.appendChild(markerNode(t)) );
  }

  function markerNode(t){
    const el = document.createElement('div');
    el.className = 'table-marker';
    el.style.left = (t.x||0) + 'px';
    el.style.top  = (t.y||0) + 'px';
    el.dataset.id = t.id;
    el.innerHTML = `<span class="table-badge"></span><span class="marker-name"></span><div class="drag-handle"></div>`;
    el.querySelector('.table-badge').textContent = t.name || 'T?';
    el.querySelector('.marker-name').textContent = (t.items?.[0] || t.notes || '').slice(0,22);

    el.addEventListener('click', ()=>{
      if(editMode) return; // avoid click while dragging
      select(t.id);
      openEditor(t.id);
      if(isMobile()) openPanel(true);
    });
    el.addEventListener('dblclick', ()=>{
      openEditor(t.id);
      if(isMobile()) openPanel(true);
    });

    // drag position in edit mode
    let drag = {active:false, dx:0, dy:0};
    el.addEventListener('pointerdown', (e)=>{
      if(!editMode) return; drag.active=true; el.classList.add('dragging');
      drag.dx = e.clientX - el.offsetLeft; drag.dy = e.clientY - el.offsetTop; el.setPointerCapture(e.pointerId);
    });
    el.addEventListener('pointermove', (e)=>{
      if(!drag.active) return; const nx = e.clientX - drag.dx; const ny = e.clientY - drag.dy; el.style.left = nx+ 'px'; el.style.top = ny + 'px';
    });
    el.addEventListener('pointerup', ()=>{
      if(!drag.active) return; drag.active=false; el.classList.remove('dragging');
      const tObj = data.tables.find(x=>x.id===t.id); tObj.x = el.offsetLeft; tObj.y = el.offsetTop; save();
    });

    return el;
  }

  function select(id){
    selectedId = id; $$('.table-marker').forEach(n=>n.classList.toggle('selected', n.dataset.id===id));
  }

  // ----- editor -----
  function openEditor(id){
    select(id);
    const t = data.tables.find(x=>x.id===id);
    $('#f-name').value = t.name || '';
    $('#f-notes').value = t.notes || '';
    renderItems(t.items);
    renderPhoto(t.photo);
  }
  function renderItems(items){
    const box = $('#f-items'); box.innerHTML='';
    if(!items || items.length===0){ box.textContent='None'; box.classList.add('muted'); return }
    box.classList.remove('muted');
    items.forEach((txt,i)=>{
      const chip = document.createElement('div'); chip.className='chip'; chip.innerHTML = `<span>${escapeHTML(txt)}</span><span class="x" title="Remove">×</span>`;
      chip.querySelector('.x').onclick = ()=>{ const t = current(); t.items.splice(i,1); renderItems(t.items); save(); }
      box.appendChild(chip);
    });
  }
  function renderPhoto(photo){
    const box = $('#photoBox'); box.innerHTML='';
    if(photo){ const img = new Image(); img.src = photo; box.appendChild(img); }
    else { box.innerHTML = '<span class="muted">No Photo</span>'; }
  }
  function current(){ return data.tables.find(x=>x.id===selectedId) }

  function bindEditor(){
    $('#f-itemInput').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && e.target.value.trim()){
        const t = current(); if(!t) return; t.items = t.items || []; t.items.push(e.target.value.trim()); e.target.value=''; renderItems(t.items); save();
      }
    });
    $('#f-photo').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      try{
        const dataUrl = await compressImage(file, {maxW: 1280, maxH: 1280, quality: 0.82});
        const t = current(); if(!t) return; t.photo = dataUrl; renderPhoto(t.photo); save();
      }catch(err){ console.error(err); alert('Failed to load photo.'); }
    });
    $('#saveBtn').onclick = ()=>{
      const t = current(); if(!t) return; t.name = $('#f-name').value.trim()||t.name; t.notes = $('#f-notes').value.trim();
      const node = board.querySelector(`.table-marker[data-id="${t.id}"]`);
      node?.querySelector('.table-badge')?.replaceChildren(document.createTextNode(t.name||'T?'));
      node?.querySelector('.marker-name')?.replaceChildren(document.createTextNode((t.items?.[0]||t.notes||'').slice(0,22)));
      save();
      flash(node);
    };
    $('#deleteBtn').onclick = ()=>{
      const t = current(); if(!t) return; if(!confirm(`Delete ${t.name || 'this table'}?`)) return;
      data.tables = data.tables.filter(x=>x.id!==t.id); try{ localStorage.removeItem(`photo:${t.id}`) }catch(e){}; save(); renderAll(); selectedId=null; if(isMobile()) openPanel(false);
    };
    $('#closeBtn').onclick = ()=>{ selectedId=null; $$('.table-marker').forEach(n=>n.classList.remove('selected')); if(isMobile()) openPanel(false); };
  }

  function flash(node){ if(!node) return; node.classList.add('pulse'); setTimeout(()=> node.classList.remove('pulse'), 600) }

  // ----- toolbar & mobile panel -----
  function bindToolbar(){
    $('#addTableBtn').onclick = ()=>{
      const id = uid(); const count = Math.floor(data.tables.length/2) + 1; // next number (approx)
      const t = {id, name:`${count} Left`, x:Math.round(board.clientWidth/2-40+Math.random()*60), y:80+Math.round(Math.random()*40), notes:'', items:[], photo:null};
      data.tables.push(t); save(); renderAll(); select(id); openEditor(id); if(isMobile()) openPanel(true);
    };
    $('#toggleEditBtn').onclick = ()=>{
      editMode = !editMode; $('#toggleEditBtn').textContent = `Layout Mode: ${editMode?'ON':'OFF'}`; $('#toggleEditBtn').classList.toggle('warn', !editMode);
      board.classList.toggle('editing', editMode);
    };
    $('#exportBtn').onclick = ()=>{
      const payload = JSON.stringify({tables: data.tables.map(t=> ({...t, photo: undefined}))}, null, 2);
      const blob = new Blob([payload], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'map-data.json'}); a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    };
    $('#importFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const parsed = JSON.parse(r.result);
          if(!parsed || !Array.isArray(parsed.tables)) throw new Error('Invalid schema');
          // migrate any photo fields to split storage
          parsed.tables.forEach(t=>{ if(t.photo){ try{ localStorage.setItem(`photo:${t.id}`, t.photo); }catch(e){} } });
          data = {tables: parsed.tables.map(t=> ({...t, photo: localStorage.getItem(`photo:${t.id}`) || null}))};
          save(); renderAll(); alert('Import succeeded');
        }catch{ alert('Import failed: invalid JSON') } };
      r.readAsText(f);
    });
    $('#resetBtn').onclick = ()=>{ if(confirm('Reset all tables? This will remove current map data.')){ data = seed(); save(); renderAll(); }};
    $('#bgFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ setBackground(r.result) }; r.readAsDataURL(f);
    });

    const search = $('#search'); const list = $('#resultList');
    function normalizeQuery(q){
      q = (q||'').trim().toLowerCase();
      const m = q.match(/^(\d{1,2})([lr])$/);
      if(m){ const num = parseInt(m[1],10); const side = m[2]==='l'?' left':' right'; return `${num}${side}`; }
      return q.replace(/\bleft\b/g,' left').replace(/\bright\b/g,' right');
    }
    function runSearch(q){
      q = normalizeQuery(q);
      list.innerHTML=''; $$('.table-marker').forEach(n=> n.classList.remove('pulse'));
      if(!q){ return }
      const matches = data.tables.filter(t=>
        (t.name||'').toLowerCase().includes(q) ||
        (t.notes||'').toLowerCase().includes(q) ||
        (t.items||[]).some(it=> it.toLowerCase().includes(q))
      );
      matches.forEach(t=>{
        const row = document.createElement('div'); row.className='match';
        const desc = escapeHTML((t.items||[]).join(', ')||t.notes||'');
        row.innerHTML = `<div><b>${escapeHTML(t.name)}</b><div class="muted" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${desc}</div></div><button class="btn">Focus</button>`;
        row.querySelector('button').onclick = ()=> focusTable(t.id);
        list.appendChild(row);
      });
      matches.forEach(t=> flash(board.querySelector(`.table-marker[data-id="${t.id}"]`)) );
      if(matches.length===1) focusTable(matches[0].id);
      if(isMobile() && matches.length>0) openPanel(true);
    }
    search.addEventListener('keydown', (e)=>{ if(e.key==='Enter') runSearch(search.value) });
    $('#clearSearch').onclick = ()=>{ search.value=''; list.innerHTML=''; $$('.table-marker').forEach(n=> n.classList.remove('pulse')) };

    function focusTable(id){
      const node = board.querySelector(`.table-marker[data-id="${id}"]`); if(!node) return;
      const rect = node.getBoundingClientRect(); const parent = board.getBoundingClientRect();
      board.scrollTo({ left: node.offsetLeft - parent.width/2 + rect.width/2, top: node.offsetTop - parent.height/2 + rect.height/2, behavior:'smooth' });
      flash(node); select(id); openEditor(id);
    }

    // Mobile bottom-sheet toggle
    togglePanelBtn?.addEventListener('click', ()=> openPanel(!editor.classList.contains('open')));
  }

  function openPanel(show){
    if(!isMobile()) return; // desktop keeps panel docked
    editor.classList.toggle('open', !!show);
    const expanded = !!show; if(togglePanelBtn){ togglePanelBtn.setAttribute('aria-expanded', String(expanded)); togglePanelBtn.textContent = expanded ? 'Hide' : 'Edit'; }
  }

  function escapeHTML(s){return (s??'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}

  // Compress image to DataURL (JPEG) to avoid localStorage quota issues on mobile
  function compressImage(file, {maxW=1280, maxH=1280, quality=0.82}={}){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          let w = img.naturalWidth || img.width;
          let h = img.naturalHeight || img.height;
          const ratio = Math.min(1, maxW / w, maxH / h);
          const cw = Math.max(1, Math.round(w * ratio));
          const ch = Math.max(1, Math.round(h * ratio));
          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, cw, ch);
          try{ resolve(canvas.toDataURL('image/jpeg', quality)); }
          catch(e){ reject(e) }
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }
})();
</script>
</body>
</html>
