<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory – Bar View (Photo Required)</title>
<style>
:root{
  --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff;
  --bar-bg:#1a2230; --bar-rem:#38d39f;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:rgba(13,17,23,.92);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #202632}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.6rem .9rem}
.btn{border:1px solid #303845;background:#12161b;color:var(--text);padding:.48rem .7rem;border-radius:.8rem;cursor:pointer}
.btn:hover{border-color:#3a4556}
.btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
.btn.ghost{background:transparent}

/* inputs */
input[type="text"],input[type="number"],textarea,select{
  background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.55rem .6rem;outline:none;max-width:100%;
}
textarea{min-height:84px;resize:vertical}
.muted{color:var(--muted)}

.wrap{max-width:980px;margin:0 auto;padding:12px}
.card{background:linear-gradient(180deg,#11151b,#0f1319);border:1px solid #1f2631;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:10px}
.list{display:flex;flex-direction:column}

.table-row{display:block;padding:12px 12px 6px;border-bottom:1px solid #1c2430;cursor:pointer}
.table-row:last-child{border-bottom:none}
.row-head{display:grid;grid-template-columns:minmax(120px,200px) 1fr max-content;gap:12px;align-items:center}
.badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;background:#152032;border:1px solid #243042;font-weight:700}
.ellip{min-width:0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:var(--muted);font-size:12px}
.stat{white-space:nowrap}
.bar{position:relative;height:14px;background:var(--bar-bg);border-radius:999px;overflow:hidden}
.bar .rem{position:absolute;inset:0 auto 0 0;background:var(--bar-rem)}

.table-row.open{background:#0e1319}
.expander{display:none;margin-top:10px;padding:12px;border:1px solid #243042;border-radius:10px;background:#0f1318}
.table-row.open .expander{display:block}

/* layout helpers */
.field    { margin:.6rem 0 }
.field-2  { display:grid; grid-template-columns:1fr 1fr; gap:.6rem }
.field-3  { display:grid; grid-template-columns:1fr 1fr 1fr; gap:.6rem }
.actions  { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }

/* photos */
.photo{width:100%;aspect-ratio:4/3;background:#0f1318;border:1px dashed #344055;border-radius:12px;display:grid;place-items:center;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover}

/* items */
.inv{border-top:1px solid #202632;margin-top:8px;padding-top:8px;max-height:260px;overflow:auto}
.inv-card{display:flex;gap:.6rem;align-items:center;border:1px solid #243042;border-radius:10px;padding:6px 8px;margin-bottom:8px}
.tag{display:inline-block;background:#152032;border:1px solid #243042;padding:.1rem .4rem;border-radius:999px;font-weight:600}

/* labels wall */
.chips{display:flex;gap:.4rem;flex-wrap:wrap}
.chip{border:1px solid #2a3240;background:#10151a;padding:.25rem .55rem;border-radius:999px}
#labelsWall{margin:8px 0 12px}
#labelsWall .title{font-size:12px;color:var(--muted);margin:0 0 6px 2px}
#labelsWall .chips{min-height:36px;border:1px dashed #2a3240;border-radius:10px;padding:8px}

/* responsive */
@media (max-width: 900px){
  .table-row{min-height:68px}
  .row-head{grid-template-columns: minmax(100px,160px) 1fr max-content}
  .field-2{ grid-template-columns:1fr; } /* stack on mobile */
}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="addTable" class="btn">Add Table</button>
    <button id="addPair" class="btn">Add Pair (Left/Right)</button>
    <input id="q" type="text" placeholder="Search item / table / note / tag…" />
    <input id="need" type="number" min="0" step="1" style="width:120px" placeholder="Required space" />
    <button id="find" class="btn ghost">Find</button>
    <button id="clear" class="btn ghost">Clear</button>
    <button id="reset" class="btn ghost">Reset</button>
  </div>
</header>

<main class="wrap">
  <div class="muted" style="margin:4px 2px 6px">Green = remaining space</div>

  <!-- Auto labels from item names -->
  <section id="labelsWall">
    <div class="title">Auto labels (from item names). Tap to filter:</div>
    <div id="labelsBox" class="chips"></div>
  </section>

  <div class="card">
    <div id="tableList" class="list"></div>
  </div>
</main>

<script>
(function(){
  var $ = function(s){ return document.querySelector(s); };
  var list = $('#tableList');
  var labelsBox = $('#labelsBox');
  var stateKey='bar.inv.photo.one.en.v2';

  var data = load() || seed();
  if(!data || !Array.isArray(data.tables)){ data = seed(); try{ localStorage.setItem(stateKey, JSON.stringify(data)); }catch(e){} }
  var openId = null;
  var labelFilter = '';

  renderLabelsWall();
  renderList();
  bindToolbar();

  // ===== model =====
  function uid(){ return 't'+Math.random().toString(36).slice(2,9); }
  function eid(){ return 'e'+Math.random().toString(36).slice(2,9); }
  function newTable(name){ return {id:uid(), name:name, notes:'', tags:[], capacity:100, entries:[], compartmentPhoto:null}; }
  function remainingOf(t){
    var ents = Array.isArray(t.entries)?t.entries:[];
    var used = ents.reduce(function(s,e){ return s + Number(e.size||0); }, 0);
    return Math.max(0, Number(t.capacity||0) - used);
  }
  function seed(){
    var tables=[], isValid=function(n){ return !/[47]/.test(String(n).padStart(2,'0')); };
    for(var n=1;n<=88;n++){ if(!isValid(n)) continue; tables.push(newTable(n+' Left')); tables.push(newTable(n+' Right')); }
    return {tables:tables};
  }
  function save(){
    try{
      var slim={tables:(Array.isArray(data.tables)?data.tables:[]).map(function(t){
        if(t.compartmentPhoto){ try{ localStorage.setItem('photo:comp:'+t.id, t.compartmentPhoto);}catch(e){} }
        return {
          id:t.id, name:t.name, notes:t.notes||'', tags:Array.isArray(t.tags)?t.tags:[],
          capacity:Number(t.capacity||0), entries:Array.isArray(t.entries)?t.entries:[]
        };
      })};
      localStorage.setItem(stateKey, JSON.stringify(slim));
      return true;
    }catch(e){ alert('Save failed: storage blocked or full.'); return false; }
  }
  function load(){
    try{
      var raw=localStorage.getItem(stateKey); if(!raw) return null;
      var slim=JSON.parse(raw); if(!slim || !Array.isArray(slim.tables)) return null;
      var tables=slim.tables.map(function(t){
        return {
          id:t.id, name:t.name, notes:t.notes||'', tags:Array.isArray(t.tags)?t.tags:[],
          capacity:Number(t.capacity||0), entries:Array.isArray(t.entries)?t.entries:[],
          compartmentPhoto: localStorage.getItem('photo:comp:'+t.id) || null
        };
      });
      return {tables:tables};
    }catch(e){ return null; }
  }

  // ===== labels wall =====
  function computeNameCounts(){
    var map = new Map();
    (data.tables||[]).forEach(function(t){
      (t.entries||[]).forEach(function(en){
        var key = String(en.name||'').trim();
        if(!key) return;
        map.set(key, (map.get(key)||0)+1);
      });
    });
    return map;
  }
  function renderLabelsWall(){
    labelsBox.innerHTML='';
    var map=computeNameCounts();
    if(map.size===0){ labelsBox.innerHTML='<span class="muted">No labels yet</span>'; return; }
    Array.from(map.entries()).sort(function(a,b){ return b[1]-a[1] || a[0].localeCompare(b[0]); })
      .forEach(function(pair){
        var name=pair[0], count=pair[1];
        var chip=document.createElement('span'); chip.className='chip';
        chip.innerHTML = '<b>'+escapeHtml(name)+'</b> <span class="muted">×'+count+'</span>';
        chip.onclick = function(){ labelFilter=name.toLowerCase(); document.getElementById('q').value=name; runSearch(); };
        labelsBox.appendChild(chip);
      });
  }

  // ===== list =====
  function renderList(items){
    try{
      items = items || (Array.isArray(data.tables)?data.tables:[]);
      items = Array.isArray(items)?items:[];
      items = items.slice().sort(function(a,b){ return remainingOf(b)-remainingOf(a); });

      list.innerHTML='';
      if(items.length===0){
        list.innerHTML='<div class="table-row"><span class="muted" style="padding:10px 12px">No tables</span></div>';
        return;
      }

      items.forEach(function(t){
        var rem=remainingOf(t), cap=Number(t.capacity||0), pct=cap>0?(rem/cap)*100:0;
        var row=document.createElement('div'); row.className='table-row';
        if(t.id===openId) row.classList.add('open');
        row.innerHTML =
          '<div class="row-head">'+
            '<div class="meta">'+
              '<span class="badge">'+escapeHtml(t.name||'')+'</span>'+
              '<span class="ellip">'+escapeHtml((t.entries&&t.entries[0]&&t.entries[0].name)||t.notes||'…')+'</span>'+
            '</div>'+
            '<div class="bar"><div class="rem" style="width:'+pct+'%"></div></div>'+
            '<div class="stat">'+rem+'/'+cap+'</div>'+
          '</div>'+
          '<div class="expander"></div>';
        row.querySelector('.row-head').onclick=function(){
          if(openId===t.id){ openId=null; renderList(); return; }
          openId=t.id; renderList();
        };
        list.appendChild(row);
        if(t.id===openId) renderRowEditor(t, row.querySelector('.expander'));
      });
    }catch(e){
      console.error('renderList error:', e);
      list.innerHTML='<div class="table-row"><span class="muted" style="padding:10px 12px">Render failed. Tap Reset and try again.</span></div>';
    }
  }

  // ===== inline editor =====
  function renderRowEditor(t,box){
    var rem=remainingOf(t), cap=Number(t.capacity||0);
    box.innerHTML =
      '<div class="field-2">'+
        '<label>Name<input class="in-name" type="text" value="'+escapeAttr(t.name||'')+'"></label>'+
        '<div></div>'+
      '</div>'+
      '<div class="field-2">'+
        '<label>Capacity<input class="in-cap" type="number" value="'+cap+'"></label>'+
        '<label>Remaining<input class="in-rem" type="number" disabled value="'+rem+'"></label>'+
      '</div>'+
      '<div class="field"><label>Notes<textarea class="in-notes" placeholder="e.g., upper shelf / power / locked">'+escapeHtml(t.notes||'')+'</textarea></label></div>'+

      '<div class="field"><strong>Current compartment photo (updated when adding items)</strong></div>'+
      '<div class="photo comp-ph">'+(t.compartmentPhoto?('<img src="'+t.compartmentPhoto+'">'):'<span class="muted">No photo</span>')+'</div>'+
      '<div class="actions" style="margin-top:6px">'+
        '<label class="btn ghost">Retake<input class="comp-photo" type="file" accept="image/*" capture="environment" hidden></label>'+
        (t.compartmentPhoto?'<button class="btn ghost comp-clear">Clear</button>':'')+
      '</div>'+

      '<hr>'+
      '<strong>Add Item (photo required)</strong>'+
      '<div class="field-2">'+
        '<label>Item name<input class="i-name" type="text" placeholder="Camera / Cake / Thermos"></label>'+
        '<label>Size<input class="i-size" type="number" min="0" step="1" placeholder="10"></label>'+
      '</div>'+
      '<div class="field">'+
        '<label>From '+
          '<select class="i-role" style="width:100%">'+
            '<option value="bar">bar</option>'+
            '<option value="host">host</option>'+
            '<option value="server">server</option>'+
            '<option value="other" selected>other</option>'+
          '</select>'+
        '</label>'+
      '</div>'+
      '<div class="field"><label>Note (optional)<input class="i-note" type="text" placeholder="Top-left / In box"></label></div>'+
      '<div class="photo i-ph"><span class="muted">Please take a photo (required)</span></div>'+
      '<div class="actions">'+
        '<label class="btn ghost">Take photo<input class="i-photo" type="file" accept="image/*" capture="environment" hidden></label>'+
        '<button class="btn ghost i-clear">Clear photo</button>'+
        '<div class="sp"></div>'+
        '<button class="btn primary i-add">Save Item</button>'+
      '</div>'+

      '<div class="field" style="margin-top:10px"><strong>Items</strong></div>'+
      '<div class="inv i-list muted">None</div>'+

      '<div class="actions" style="margin-top:10px">'+
        '<button class="btn primary btn-save">Save Table</button>'+
        '<button class="btn btn-del-table" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">Delete Table</button>'+
      '</div>';

    // table fields
    box.querySelector('.in-name').onchange=function(e){ t.name=e.target.value.trim(); save(); renderList(); };
    box.querySelector('.in-cap').onchange=function(e){ t.capacity=Number(e.target.value)||0; box.querySelector('.in-rem').value=remainingOf(t); save(); renderList(); };
    box.querySelector('.in-notes').onchange=function(e){ t.notes=e.target.value; save(); renderList(); };

    // compartment photo
    var compInput = box.querySelector('.comp-photo');
    if(compInput){
      compInput.addEventListener('change', function(ev){
        var f = ev.target.files && ev.target.files[0]; if(!f) return;
        compressImage(f).then(function(dt){
          t.compartmentPhoto = dt;
          try{ localStorage.setItem('photo:comp:'+t.id, dt); }catch(e){}
          save(); renderRowEditor(t,box); renderList();
        }).catch(function(){});
      });
    }
    var compClear = box.querySelector('.comp-clear');
    if(compClear){
      compClear.onclick=function(){
        t.compartmentPhoto=null; try{ localStorage.removeItem('photo:comp:'+t.id); }catch(e){}
        save(); renderRowEditor(t,box); renderList();
      };
    }

    // add item (photo required)
    var itemPhoto=null;
    var iph=box.querySelector('.i-ph');
    box.querySelector('.i-photo').addEventListener('change', function(ev){
      var f=ev.target.files && ev.target.files[0]; if(!f) return;
      compressImage(f).then(function(dt){ itemPhoto=dt; iph.innerHTML='<img src="'+dt+'">'; }).catch(function(){});
    });
    box.querySelector('.i-clear').onclick=function(){ itemPhoto=null; iph.innerHTML='<span class="muted">Please take a photo (required)</span>'; };

    box.querySelector('.i-add').onclick=function(){
      var name = box.querySelector('.i-name').value.trim();
      var size = Number(box.querySelector('.i-size').value||0);
      var role = box.querySelector('.i-role').value;
      var note = box.querySelector('.i-note').value.trim();
      if(!name){ alert('Please enter item name'); return; }
      if(size<0){ alert('Size must be ≥ 0'); return; }
      if(!itemPhoto){ alert('Photo is required'); return; }

      // update current compartment photo
      t.compartmentPhoto = itemPhoto;
      try{ localStorage.setItem('photo:comp:'+t.id, itemPhoto); }catch(e){}

      if(!Array.isArray(t.entries)) t.entries=[];
      t.entries.unshift({id:eid(), name:name, size:size, note:note, role:role, addedAt:Date.now()});

      // clear form
      box.querySelector('.i-name').value=''; box.querySelector('.i-size').value=''; box.querySelector('.i-note').value='';
      itemPhoto=null; iph.innerHTML='<span class="muted">Please take a photo (required)</span>';

      // update ui
      var remInput=box.querySelector('.in-rem'); if(remInput) remInput.value=remainingOf(t);
      save(); renderInvList(t, box.querySelector('.i-list')); renderLabelsWall(); renderList();
    };

    renderInvList(t, box.querySelector('.i-list'));

    // save / delete
    box.querySelector('.btn-save').onclick=function(){ save(); renderList(); };
    var delBtn = box.querySelector('.btn-del-table');
    if(delBtn){
      delBtn.onclick=function(){
        if(!confirm('Delete '+(t.name||'this table')+'?')) return;
        try{ localStorage.removeItem('photo:comp:'+t.id); }catch(e){}
        data.tables=(data.tables||[]).filter(function(x){ return x.id!==t.id; });
        openId=null; save(); renderLabelsWall(); renderList();
      };
    }
  }

  function renderInvList(t, container){
    container.innerHTML='';
    var arr=Array.isArray(t.entries)?t.entries:[];
    if(arr.length===0){ container.textContent='None'; container.classList.add('muted'); return; }
    container.classList.remove('muted');
    arr.forEach(function(en){
      var row=document.createElement('div'); row.className='inv-card';
      row.innerHTML =
        '<div>'+
          '<div><b>'+escapeHtml(en.name)+'</b> <span class="tag">Size '+Number(en.size||0)+'</span> <span class="tag">'+escapeHtml(en.role||'other')+'</span></div>'+
          '<div class="muted" style="max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+escapeHtml(en.note||'')+'</div>'+
          '<div class="muted" style="font-size:12px">'+new Date(en.addedAt).toLocaleString()+'</div>'+
        '</div>'+
        '<div class="sp"></div>'+
        '<button class="btn btn-del" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">Delete</button>';
      row.querySelector('.btn-del').onclick=function(){
        t.entries=(t.entries||[]).filter(function(x){ return x.id!==en.id; });
        save(); renderInvList(t, container); renderLabelsWall();
        var ex = container.closest ? container.closest('.expander') : container.parentNode;
        if(ex){ var remInput=ex.querySelector('.in-rem'); if(remInput) remInput.value=remainingOf(t); }
        renderList();
      };
      container.appendChild(row);
    });
  }

  // ===== toolbar =====
  function bindToolbar(){
    document.getElementById('addTable').onclick=function(){
      var t=newTable('Custom '+(((data.tables||[]).length)+1)); data.tables.unshift(t); openId=t.id; save(); renderLabelsWall(); renderList();
    };
    document.getElementById('addPair').onclick=function(){
      var n=nextAvailableNumber(); if(n==null){ alert('No valid numbers left (4/7 excluded)'); return; }
      var left=newTable(n+' Left'), right=newTable(n+' Right'); data.tables.unshift(right); data.tables.unshift(left);
      openId=left.id; save(); renderList();
    };
    document.getElementById('find').onclick=runSearch;
    document.getElementById('q').onkeydown=function(e){ if(e.key==='Enter') runSearch(); };
    document.getElementById('need').onkeydown=function(e){ if(e.key==='Enter') runSearch(); };
    document.getElementById('clear').onclick=function(){ document.getElementById('q').value=''; document.getElementById('need').value=''; labelFilter=''; openId=null; renderList(); };
    document.getElementById('reset').onclick=doReset;
  }
  function runSearch(){
    var kw = document.getElementById('q').value.trim().toLowerCase();
    var req = Number(document.getElementById('need').value)||0;
    var out=(data.tables||[]).filter(function(t){
      var textHit = !kw ||
        String(t.name||'').toLowerCase().includes(kw) ||
        String(t.notes||'').toLowerCase().includes(kw) ||
        (Array.isArray(t.tags) && t.tags.some(function(x){return String(x).toLowerCase().includes(kw);} )) ||
        (Array.isArray(t.entries) && t.entries.some(function(en){
          return String(en.name||'').toLowerCase().includes(kw) || String(en.note||'').toLowerCase().includes(kw);
        }));
      var labelHit = !labelFilter || (Array.isArray(t.entries) && t.entries.some(function(en){ return String(en.name||'').toLowerCase()===labelFilter; }));
      var spaceHit = isNaN(req) || req<=0 || remainingOf(t)>=req;
      return textHit && labelHit && spaceHit;
    });
    openId=null; renderList(out);
  }
  function doReset(){
    if(!confirm('Reset will clear local data and rebuild default tables. Continue?')) return;
    try{
      var raw=localStorage.getItem(stateKey);
      if(raw){
        var parsed=JSON.parse(raw);
        if(parsed && Array.isArray(parsed.tables)){
          parsed.tables.forEach(function(t){ localStorage.removeItem('photo:comp:'+t.id); });
        }
      }
    }catch(e){}
    localStorage.removeItem(stateKey);
    data=seed(); openId=null;
    try{ localStorage.setItem(stateKey, JSON.stringify(data)); }catch(e){}
    renderLabelsWall(); renderList(); alert('Reset done.');
  }

  // ===== utils =====
  function escapeHtml(s){ return (s==null?'':String(s)).replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);}); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  function compressImage(file,opts){
    opts=opts||{}; var maxW=opts.maxW||1280, maxH=opts.maxH||1280, q=('quality' in opts)?opts.quality:0.82;
    return new Promise(function(resolve,reject){
      var r=new FileReader();
      r.onload=function(){
        var img=new Image();
        img.onload=function(){
          var w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
          var ratio=Math.min(1,maxW/w,maxH/h), cw=Math.max(1,Math.round(w*ratio)), ch=Math.max(1,Math.round(h*ratio));
          var c=document.createElement('canvas'); c.width=cw; c.height=ch;
          var ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
          try{ resolve(c.toDataURL('image/jpeg',q)); }catch(e){ reject(e); }
        };
        img.onerror=reject; img.src=r.result;
      };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }
  function parseNumberAndSide(name){
    var m=String(name||'').match(/^(\d{1,2})\s+(left|right)$/i);
    return m?{num:+m[1],side:m[2].toLowerCase()}:null;
  }
  function isValidNumber(n){ return n>=1 && n<=88 && !/[47]/.test(String(n).padStart(2,'0')); }
  function nextAvailableNumber(){
    var used=new Map();
    (data.tables||[]).forEach(function(t){
      var p=parseNumberAndSide(t.name); if(!p || !isValidNumber(p.num)) return;
      if(!used.has(p.num)) used.set(p.num,new Set()); used.get(p.num).add(p.side);
    });
    for(var n=1;n<=88;n++){ if(!isValidNumber(n)) continue; var s=used.get(n); if(!s || s.size<2) return n; }
    return null;
  }
})();
</script>
</body>
</html>
