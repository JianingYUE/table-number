<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>库存 – 条形视图（拍照版）</title>
<style>
:root{
  --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff;
  --bar-bg:#1a2230; --bar-rem:#38d39f; --bar-used:#2a3344;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:rgba(13,17,23,.92);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #202632}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.6rem .9rem}
.btn{border:1px solid #303845;background:#12161b;color:var(--text);padding:.48rem .7rem;border-radius:.8rem;cursor:pointer}
.btn:hover{border-color:#3a4556}
.btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
.btn.ghost{background:transparent}
input[type="text"],input[type="number"],textarea,select{background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.55rem .6rem;outline:none}
textarea{min-height:84px;resize:vertical}
.muted{color:var(--muted)}

.wrap{max-width:980px;margin:0 auto;padding:12px}
.card{background:linear-gradient(180deg,#11151b,#0f1319);border:1px solid #1f2631;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:10px}
.list{display:flex;flex-direction:column}

.table-row{display:block;padding:12px 12px 6px;border-bottom:1px solid #1c2430;cursor:pointer}
.table-row:last-child{border-bottom:none}
.row-head{display:grid;grid-template-columns:minmax(120px,200px) 1fr max-content;gap:12px;align-items:center}
.badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;background:#152032;border:1px solid #243042;font-weight:700}
.ellip{min-width:0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:var(--muted);font-size:12px}
.stat{white-space:nowrap}
.bar{position:relative;height:14px;background:var(--bar-bg);border-radius:999px;overflow:hidden}
.bar .rem{position:absolute;inset:0 auto 0 0;background:var(--bar-rem)}

.table-row.open{background:#0e1319}
.expander{display:none;margin-top:10px;padding:12px;border:1px solid #243042;border-radius:10px;background:#0f1318}
.table-row.open .expander{display:block}

.field-2{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.field-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.6rem}
.field{margin:.6rem 0}
.actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}

.photo{width:100%;aspect-ratio:4/3;background:#0f1318;border:1px dashed #344055;border-radius:12px;display:grid;place-items:center;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover}

.inv{border-top:1px solid #202632;margin-top:8px;padding-top:8px;max-height:260px;overflow:auto}
.inv-card{display:flex;gap:.6rem;align-items:center;border:1px solid #243042;border-radius:10px;padding:6px 8px;margin-bottom:8px}
.tag{display:inline-block;background:#152032;border:1px solid #243042;padding:.1rem .4rem;border-radius:999px;font-weight:600}

.chips{display:flex;gap:.4rem;flex-wrap:wrap}
.chip{border:1px solid #2a3240;background:#10151a;padding:.25rem .55rem;border-radius:999px}
.chip b{font-weight:700}
.chip .x{margin-left:.35rem;opacity:.7;font-weight:700;cursor:pointer}

#labelsWall{margin:8px 0 12px}
#labelsWall .title{font-size:12px;color:var(--muted);margin:0 0 6px 2px}
#labelsWall .chips{max-height:92px;overflow:auto;border:1px dashed #2a3240;border-radius:10px;padding:8px}

@media (max-width: 900px){
  .table-row{min-height:68px}
  .row-head{grid-template-columns: minmax(100px,160px) 1fr max-content}
}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="addTable" class="btn">新增桌子</button>
    <button id="addPair" class="btn">新增一对（Left/Right）</button>
    <input id="q" type="text" placeholder="搜索 物品/桌名/备注/标签…" />
    <input id="need" type="number" min="0" step="1" style="width:120px" placeholder="需要空间" />
    <button id="find" class="btn ghost">搜索</button>
    <button id="clear" class="btn ghost">清空</button>
  </div>
</header>

<main class="wrap">
  <div class="muted" style="margin:4px 2px 6px">Green = remaining space</div>

  <!-- 物品名标签墙（自动增删） -->
  <section id="labelsWall">
    <div class="title">物品标签（自动）：点击可快速筛选</div>
    <div id="labelsBox" class="chips"></div>
  </section>

  <div class="card">
    <div id="tableList" class="list"></div>
  </div>
</main>

<script>
(function(){
  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const list = $('#tableList');
  const labelsBox = $('#labelsBox');
  const stateKey='bar.inv.photo.one.v1';

  let data = load() || seed();
  let openId = null;
  let labelFilter = ''; // 点击标签后的快速筛选

  renderLabelsWall();
  renderList();
  bindToolbar();

  // ======= 数据模型 =======
  function uid(){ return 't'+Math.random().toString(36).slice(2,9) }
  function eid(){ return 'e'+Math.random().toString(36).slice(2,9) }
  function newTable(name){ return {id:uid(), name, notes:'', tags:[], capacity:100, entries:[], compartmentPhoto:null}; }
  function remainingOf(t){ const used=(t.entries||[]).reduce((s,e)=>s+Number(e.size||0),0); return Math.max(0, Number(t.capacity||0)-used); }

  function seed(){
    const tables=[]; const isValid=n=>!/[47]/.test(String(n).padStart(2,'0'));
    for(let n=1;n<=88;n++){ if(!isValid(n)) continue; tables.push(newTable(`${n} Left`)); tables.push(newTable(`${n} Right`)); }
    return {tables};
  }

  function save(){
    try{
      const slim={tables:data.tables.map(t=>{
        if(t.compartmentPhoto){ try{ localStorage.setItem('photo:comp:'+t.id, t.compartmentPhoto);}catch(e){} }
        const {compartmentPhoto, ...rest}=t;
        return {...rest};
      })};
      localStorage.setItem(stateKey, JSON.stringify(slim));
      return true;
    }catch(e){ alert('保存失败：本地存储空间不足或被阻止'); return false; }
  }
  function load(){
    try{
      const raw=localStorage.getItem(stateKey); if(!raw) return null;
      const slim=JSON.parse(raw);
      const tables=(slim.tables||[]).map(t=>({...t, compartmentPhoto:localStorage.getItem('photo:comp:'+t.id)||null}));
      return {tables};
    }catch{ return null }
  }

  // ======= 标签墙（按物品名汇总） =======
  function computeNameCounts(){
    const map = new Map();
    for(const t of data.tables){
      for(const en of (t.entries||[])){
        const key=(en.name||'').trim();
        if(!key) continue;
        map.set(key,(map.get(key)||0)+1);
      }
    }
    return map; // name -> count
  }
  function renderLabelsWall(){
    labelsBox.innerHTML='';
    const map=computeNameCounts();
    if(map.size===0){ labelsBox.innerHTML='<span class="muted">暂无标签</span>'; return; }
    const frag=document.createDocumentFragment();
    [...map.entries()].sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0])).forEach(([name,count])=>{
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML = `<b>${escape(name)}</b> <span class="muted">×${count}</span>`;
      chip.onclick = ()=>{ labelFilter = name.toLowerCase(); $('#q').value = name; runSearch(); };
      frag.appendChild(chip);
    });
    labelsBox.appendChild(frag);
  }

  // ======= 列表（默认按剩余降序） =======
  function renderList(items=data.tables){
    items=[...items].sort((a,b)=>remainingOf(b)-remainingOf(a));
    list.innerHTML='';
    if(!items.length){ list.innerHTML='<div class="table-row"><span class="muted" style="padding:10px 12px">没有桌子</span></div>'; return; }

    items.forEach(t=>{
      const rem=remainingOf(t), cap=Number(t.capacity||0), pct=cap>0?(rem/cap)*100:0;
      const row=document.createElement('div');
      row.className='table-row';
      if(t.id===openId) row.classList.add('open');
      row.innerHTML=`
        <div class="row-head">
          <div class="meta">
            <span class="badge">${escape(t.name)}</span>
            <span class="ellip">${escape(t.entries?.[0]?.name||t.notes||'…')}</span>
          </div>
          <div class="bar"><div class="rem" style="width:${pct}%"></div></div>
          <div class="stat">${rem}/${cap}</div>
        </div>
        <div class="expander"></div>`;
      row.querySelector('.row-head').onclick=()=>{
        if(openId===t.id){openId=null;renderList();return;}
        openId=t.id;renderList();
      };
      list.appendChild(row);
      if(t.id===openId) renderRowEditor(t,row.querySelector('.expander'));
    });
  }

  // ======= 行内展开编辑（含必须拍照） =======
  function renderRowEditor(t,box){
    const rem=remainingOf(t), cap=Number(t.capacity||0);
    box.innerHTML=`
      <div class="field-2">
        <label>名称<input class="in-name" type="text" value="${escapeAttr(t.name)}"></label>
        <div></div>
      </div>
      <div class="field-2">
        <label>总容量<input class="in-cap" type="number" value="${cap}"></label>
        <label>剩余<input class="in-rem" type="number" disabled value="${rem}"></label>
      </div>
      <div class="field"><label>备注<textarea class="in-notes" placeholder="例如：上层/有电源/加锁">${escape(t.notes||'')}</textarea></label></div>

      <div class="field"><strong>当前内部照片（必拍，新增物品时会更新）</strong></div>
      <div class="photo comp-ph">${t.compartmentPhoto?`<img src="${t.compartmentPhoto}">`:'<span class="muted">暂无照片</span>'}</div>
      <div class="actions" style="margin-top:6px">
        <label class="btn ghost">重新拍照<input class="comp-photo" type="file" accept="image/*" capture="environment" hidden></label>
        ${t.compartmentPhoto?'<button class="btn ghost comp-clear">清除</button>':''}
      </div>

      <hr>
      <strong>新增物品（必须拍照）</strong>
      <div class="field-3">
        <label>名称<input class="i-name" type="text" placeholder="相机 / 蛋糕 / 保温壶"></label>
        <label>大小<input class="i-size" type="number" min="0" step="1" placeholder="10"></label>
        <label>来源
          <select class="i-role">
            <option value="bar">bar</option>
            <option value="host">host</option>
            <option value="server">server</option>
            <option value="other" selected>other</option>
          </select>
        </label>
      </div>
      <div class="field"><label>备注（可选）<input class="i-note" type="text" placeholder="左上角 / 箱内"></label></div>
      <div class="photo i-ph"><span class="muted">新增物品时请拍照（必填）</span></div>
      <div class="actions">
        <label class="btn ghost">拍照<input class="i-photo" type="file" accept="image/*" capture="environment" hidden></label>
        <button class="btn ghost i-clear">清除照片</button>
        <div class="sp"></div>
        <button class="btn primary i-add">保存物品</button>
      </div>

      <div class="field" style="margin-top:10px"><strong>物品列表</strong></div>
      <div class="inv i-list muted">暂无</div>

      <div class="actions" style="margin-top:10px">
        <button class="btn primary btn-save">保存桌子</button>
        <button class="btn" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">删除桌子</button>
      </div>`;

    // 基本字段
    box.querySelector('.in-name').onchange=e=>{t.name=e.target.value.trim();save();renderList();}
    box.querySelector('.in-cap').onchange=e=>{t.capacity=Number(e.target.value)||0;box.querySelector('.in-rem').value=remainingOf(t);save();renderList();}
    box.querySelector('.in-notes').onchange=e=>{t.notes=e.target.value;save();renderList();}

    // 仅保留“当前内部照片”一张（无历史）
    const compInput=box.querySelector('.comp-photo');
    if(compInput){ compInput.addEventListener('change', async ev=>{
      const f=ev.target.files?.[0]; if(!f) return;
      try{ t.compartmentPhoto = await compressImage(f); localStorage.setItem('photo:comp:'+t.id, t.compartmentPhoto); save(); renderRowEditor(t,box); renderList(); }catch{}
    });}
    const compClear=box.querySelector('.comp-clear');
    if(compClear){ compClear.onclick=()=>{ t.compartmentPhoto=null; try{ localStorage.removeItem('photo:comp:'+t.id);}catch{}; save(); renderRowEditor(t,box); renderList(); }; }

    // 新增物品：必须拍照
    let itemPhoto=null;
    const iph=box.querySelector('.i-ph');
    box.querySelector('.i-photo').addEventListener('change', async ev=>{
      const f=ev.target.files?.[0]; if(!f) return;
      try{ itemPhoto=await compressImage(f); iph.innerHTML=`<img src="${itemPhoto}">`; }catch{}
    });
    box.querySelector('.i-clear').onclick=()=>{ itemPhoto=null; iph.innerHTML='<span class="muted">新增物品时请拍照（必填）</span>'; };

    box.querySelector('.i-add').onclick=()=>{
      const name=box.querySelector('.i-name').value.trim();
      const size=Number(box.querySelector('.i-size').value||0);
      const role=box.querySelector('.i-role').value;
      const note=box.querySelector('.i-note').value.trim();
      if(!name){ alert('请输入物品名称'); return; }
      if(size<0){ alert('大小需≥0'); return; }
      if(!itemPhoto){ alert('请为新增物品拍照（必填）'); return; }

      // 更新桌子的“当前内部照片”为这次拍的照片
      t.compartmentPhoto = itemPhoto;
      try{ localStorage.setItem('photo:comp:'+t.id, itemPhoto); }catch{}

      // 写入物品
      t.entries.unshift({id:eid(), name, size, note, role, addedAt:Date.now()});

      // 清空表单
      box.querySelector('.i-name').value=''; box.querySelector('.i-size').value=''; box.querySelector('.i-note').value='';
      itemPhoto=null; iph.innerHTML='<span class="muted">新增物品时请拍照（必填）</span>';

      // 更新 UI
      box.querySelector('.in-rem').value=remainingOf(t);
      save(); renderInvList(t, box.querySelector('.i-list')); renderLabelsWall(); renderList();
    };

    // 物品列表
    renderInvList(t, box.querySelector('.i-list'));

    // 保存/删除
    box.querySelector('.btn-save').onclick=()=>{save();renderList();}
    box.querySelector('.actions .btn:last-child').onclick=()=>{
      if(!confirm(`删除 ${t.name}?`)) return;
      try{ localStorage.removeItem('photo:comp:'+t.id);}catch{}
      data.tables=data.tables.filter(x=>x.id!==t.id); openId=null; save(); renderLabelsWall(); renderList();
    };
  }

  function renderInvList(t, container){
    container.innerHTML='';
    const arr=t.entries||[];
    if(!arr.length){ container.textContent='暂无'; container.classList.add('muted'); return; }
    container.classList.remove('muted');
    arr.forEach(en=>{
      const row=document.createElement('div'); row.className='inv-card';
      row.innerHTML = `
        <div>
          <div><b>${escape(en.name)}</b> <span class="tag">Size ${Number(en.size||0)}</span> <span class="tag">${escape(en.role||'other')}</span></div>
          <div class="muted" style="max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escape(en.note||'')}</div>
          <div class="muted" style="font-size:12px">${new Date(en.addedAt).toLocaleString()}</div>
        </div>
        <div class="sp"></div>
        <button class="btn btn-del" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">删除</button>`;
      row.querySelector('.btn-del').onclick=()=>{
        t.entries=t.entries.filter(x=>x.id!==en.id);
        save(); renderInvList(t, container); renderLabelsWall();
        // 同步剩余
        const ex = container.closest('.expander'); ex?.querySelector('.in-rem')?.value = remainingOf(t);
        renderList();
      };
      container.appendChild(row);
    });
  }

  // ======= 工具栏 / 搜索 =======
  function bindToolbar(){
    $('#addTable').onclick=()=>{const t=newTable('Custom '+(data.tables.length+1));data.tables.unshift(t);openId=t.id;save();renderLabelsWall();renderList();};
    $('#addPair').onclick=()=>{const n=nextAvailableNumber();if(n==null){alert('有效编号已用完（排除含4/7）');return;}const left=newTable(`${n} Left`),right=newTable(`${n} Right`);data.tables.unshift(right,left);openId=left.id;save();renderList();};
    $('#find').onclick=runSearch; $('#q').onkeydown=e=>{if(e.key==='Enter')runSearch()}; $('#need').onkeydown=e=>{if(e.key==='Enter')runSearch()};
    $('#clear').onclick=()=>{$('#q').value='';$('#need').value='';labelFilter='';openId=null;renderList();}
  }
  function runSearch(){
    const kw=$('#q').value.trim().toLowerCase();
    const req=Number($('#need').value)||0;
    const out=data.tables.filter(t=>{
      const textHit = !kw ||
        (t.name||'').toLowerCase().includes(kw) ||
        (t.notes||'').toLowerCase().includes(kw) ||
        (t.tags||[]).some(x=>String(x).toLowerCase().includes(kw)) ||
        (t.entries||[]).some(en=> (en.name||'').toLowerCase().includes(kw) || (en.note||'').toLowerCase().includes(kw));
      const labelHit = !labelFilter || (t.entries||[]).some(en=> (en.name||'').toLowerCase()===labelFilter);
      const spaceHit = isNaN(req) || req<=0 || remainingOf(t)>=req;
      return textHit && labelHit && spaceHit;
    });
    openId=null; renderList(out);
  }

  // ======= 杂项工具 =======
  function escape(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
  function escapeAttr(s){return escape(s).replace(/"/g,'&quot;')}
  function compressImage(file,{maxW=1280,maxH=1280,quality=0.82}={}){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>{ const img=new Image(); img.onload=()=>{
          const w=img.naturalWidth||img.width,h=img.naturalHeight||img.height;
          const ratio=Math.min(1,maxW/w,maxH/h), cw=Math.max(1,Math.round(w*ratio)), ch=Math.max(1,Math.round(h*ratio));
          const c=document.createElement('canvas'); c.width=cw; c.height=ch; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
          try{ resolve(c.toDataURL('image/jpeg',quality)); }catch(e){ reject(e); }
        }; img.onerror=reject; img.src=r.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }
  function parseNumberAndSide(name){const m=String(name||'').match(/^(\d{1,2})\s+(left|right)$/i);return m?{num:+m[1],side:m[2].toLowerCase()}:null}
  function isValidNumber(n){return n>=1&&n<=88&&!/[47]/.test(String(n).padStart(2,'0'))}
  function nextAvailableNumber(){
    const used=new Map();
    for(const t of data.tables){ const p=parseNumberAndSide(t.name); if(!p || !isValidNumber(p.num)) continue; if(!used.has(p.num)) used.set(p.num,new Set()); used.get(p.num).add(p.side); }
    for(let n=1;n<=88;n++){ if(!isValidNumber(n)) continue; const s=used.get(n); if(!s || s.size<2) return n; }
    return null;
  }
})();
</script>
</body>
</html>
