<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory – Bar View (Inline Edit)</title>
<style>
:root{
  --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff;
  --bar-bg:#1a2230; --bar-rem:#38d39f; --bar-used:#2a3344;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:rgba(13,17,23,.92);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #202632}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.6rem .9rem}
.btn, input[type="file"]::file-selector-button, .chip{border:1px solid #303845;background:#12161b;color:var(--text);padding:.48rem .7rem;border-radius:.8rem;cursor:pointer}
.btn:hover{border-color:#3a4556}
.btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
.btn.ghost{background:transparent}
input[type="text"],input[type="number"],textarea{background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.55rem .6rem;outline:none}
textarea{min-height:84px;resize:vertical}
.muted{color:var(--muted)}

.wrap{max-width:960px;margin:0 auto;padding:12px}
.card{background:linear-gradient(180deg,#11151b,#0f1319);border:1px solid #1f2631;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
.list{display:flex;flex-direction:column}

.table-row{display:block;padding:12px 12px 6px;border-bottom:1px solid #1c2430;cursor:pointer}
.table-row:last-child{border-bottom:none}
.row-head{display:grid;grid-template-columns:minmax(120px,200px) 1fr max-content;gap:12px;align-items:center}
.row-head .meta{display:flex;gap:8px;align-items:center;min-width:0}
.badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;background:#152032;border:1px solid #243042;font-weight:700}
.ellip{min-width:0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:var(--muted);font-size:12px}
.stat{white-space:nowrap}
.bar{position:relative;height:14px;background:var(--bar-bg);border-radius:999px;overflow:hidden}
.bar .rem{position:absolute;inset:0 auto 0 0;background:var(--bar-rem)}
.bar .used{position:absolute;inset:0 0 0 auto;background:var(--bar-used)}

.table-row:active{background:#0e1319}
.table-row.open{background:#0e1319}

.expander{display:none;margin-top:10px;padding:12px;border:1px solid #243042;border-radius:10px;background:#0f1318}
.table-row.open .expander{display:block}

/* 表单块 */
.field-2{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.field{margin:.6rem 0}
.actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.photo{width:100%;aspect-ratio:4/3;background:#0f1318;border:1px dashed #344055;border-radius:12px;display:grid;place-items:center;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover}
.chips{display:flex;gap:.4rem;flex-wrap:wrap}
.chip .x{margin-left:.35rem;opacity:.7;font-weight:700;cursor:pointer}

.inv{border-top:1px solid #202632;margin-top:8px;padding-top:8px;max-height:260px;overflow:auto}
.inv-card{display:flex;gap:.6rem;align-items:center;border:1px solid #243042;border-radius:10px;padding:6px 8px;margin-bottom:8px}
.inv-thumb{width:56px;height:42px;flex:0 0 56px;background:#0f1318;border:1px solid #2a3240;border-radius:8px;overflow:hidden;display:grid;place-items:center}
.inv-thumb img{width:100%;height:100%;object-fit:cover}
.tag{display:inline-block;background:#152032;border:1px solid #243042;padding:.1rem .4rem;border-radius:999px;font-weight:600}

@media (max-width: 900px){
  .table-row{min-height:68px}
  .row-head{grid-template-columns: minmax(100px,160px) 1fr max-content}
}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="addTable" class="btn">Add Table</button>
    <button id="addPair" class="btn">Add Pair</button>
    <input id="q" type="text" placeholder="搜索物品/桌名/备注/标签…" />
    <input id="need" type="number" min="0" step="1" style="width:120px" placeholder="需要空间" />
    <button id="find" class="btn ghost">Find</button>
    <button id="clear" class="btn ghost">Clear</button>
    <div class="sp"></div>
    <span class="muted">绿色表示剩余空间</span>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div id="tableList" class="list"></div>
  </div>
</main>

<script>
(function(){
  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const list = $('#tableList');
  const stateKey='bar.inv.inline.v1';

  let data = load() || seed();
  let openId = null; // 当前展开的行

  // init
  renderList();
  bindToolbar();

  // ======= data model =======
  function uid(){ return 't'+Math.random().toString(36).slice(2,9) }
  function eid(){ return 'e'+Math.random().toString(36).slice(2,9) }
  function newTable(name){ return {id:uid(), name, notes:'', tags:[], capacity:100, entries:[], tablePhoto:null}; }
  function remainingOf(t){ const used=(t.entries||[]).reduce((s,e)=>s+Number(e.size||0),0); return Math.max(0, Number(t.capacity||0)-used); }

  function seed(){
    const tables=[]; const isValid=n=>!/[47]/.test(String(n).padStart(2,'0'));
    for(let n=1;n<=88;n++){ if(!isValid(n)) continue; tables.push(newTable(`${n} Left`)); tables.push(newTable(`${n} Right`)); }
    return {tables};
  }

  // ======= storage (split photos) =======
  function save(){
    try{
      const slim={tables:data.tables.map(t=>{
        if(t.tablePhoto){ try{ localStorage.setItem('photo:table:'+t.id, t.tablePhoto);}catch(e){} }
        (t.entries||[]).forEach(en=>{ if(en.photo){ try{ localStorage.setItem('photo:entry:'+en.id, en.photo);}catch(e){} }});
        const {tablePhoto, entries, ...rest}=t;
        const es=(entries||[]).map(en=>{ const {photo,...r}=en; return r; });
        return {...rest, entries:es};
      })};
      localStorage.setItem(stateKey, JSON.stringify(slim));
      return true;
    }catch(e){
      alert('保存失败：浏览器存储已满或被阻止。可尝试清除旧照片。'); return false;
    }
  }
  function load(){
    try{
      const raw=localStorage.getItem(stateKey); if(!raw) return null;
      const slim=JSON.parse(raw);
      const tables=(slim.tables||[]).map(t=>{
        const tablePhoto=localStorage.getItem('photo:table:'+t.id)||null;
        const entries=(t.entries||[]).map(en=>({...en, photo:localStorage.getItem('photo:entry:'+en.id)||null}));
        return {...t, tablePhoto, entries};
      });
      return {tables};
    }catch{ return null }
  }

  // ======= render list (sorted by remaining desc) =======
  function renderList(items=data.tables){
    // 默认：按剩余空间降序
    items = [...items].sort((a,b)=> remainingOf(b) - remainingOf(a));

    list.innerHTML='';
    if(!items.length){ list.innerHTML='<div class="table-row"><div class="row-head"><span class="muted">暂无桌子</span></div></div>'; return; }

    items.forEach(t=>{
      const rem=remainingOf(t), cap=Number(t.capacity||0), used=Math.max(0, cap-rem);
      const pct = cap>0 ? (rem/cap)*100 : 0;

      const row = document.createElement('div');
      row.className='table-row';
      if(t.id===openId) row.classList.add('open');

      row.innerHTML = `
        <div class="row-head">
          <div class="meta">
            <span class="badge">${escape(t.name||'T?')}</span>
            <span class="ellip">${escape(t.entries?.[0]?.name || t.notes || '…')}</span>
          </div>
          <div>
            <div class="bar"><div class="rem" style="width:${pct}%"></div><div class="used" style="width:${100-pct}%"></div></div>
          </div>
          <div class="stat">${rem}/${cap}</div>
        </div>
        <div class="expander"></div>
      `;

      // 点击头部区域切换展开
      row.querySelector('.row-head').addEventListener('click', ()=>{
        if(openId === t.id){ openId=null; row.classList.remove('open'); row.querySelector('.expander').innerHTML=''; return; }
        // 关闭其他
        $$('.table-row.open').forEach(n=>{ n.classList.remove('open'); const ex=n.querySelector('.expander'); if(ex) ex.innerHTML=''; });
        openId = t.id;
        row.classList.add('open');
        renderRowEditor(t, row.querySelector('.expander'));
        // 让展开区滚动到可见
        setTimeout(()=> row.scrollIntoView({behavior:'smooth', block:'start'}), 0);
      });

      list.appendChild(row);
      // 首屏打开保持展开
      if(t.id===openId){
        renderRowEditor(t, row.querySelector('.expander'));
      }
    });
  }

  // ======= inline editor (in-row) =======
  function renderRowEditor(t, box){
    const rem = remainingOf(t), cap = Number(t.capacity||0);
    box.innerHTML = `
      <div class="field-2">
        <label>名称<input class="in-name" type="text" value="${escapeAttr(t.name||'')}"></label>
        <div></div>
      </div>
      <div class="field-2">
        <label>总容量<input class="in-cap" type="number" min="0" step="1" value="${cap}"></label>
        <label>剩余<input class="in-rem" type="number" disabled value="${rem}"></label>
      </div>
      <div class="field">
        <label>备注<textarea class="in-notes" placeholder="例如：上层/有电源/加锁等">${escape(t.notes||'')}</textarea></label>
      </div>

      <div class="photo t-photo">${t.tablePhoto?`<img src="${t.tablePhoto}">`:'<span class="muted">无桌面照片</span>'}</div>
      <div class="actions" style="margin-top:6px">
        <label class="btn ghost">桌面照片<input class="in-photo" type="file" accept="image/*" capture="environment" hidden></label>
        ${t.tablePhoto?'<button class="btn ghost btn-clear-photo">清除</button>':''}
      </div>

      <div class="field">
        <label>标签（回车添加）<input class="tag-input" type="text" placeholder="Fragile, VIP"></label>
        <div class="chips tag-box">${renderTagsHtml(t.tags)}</div>
      </div>

      <hr style="border:none;border-top:1px solid #202632;margin:8px 0">
      <strong>添加物品</strong>
      <div class="field-2">
        <label>物品名<input class="i-name" type="text" placeholder="相机 / 蛋糕 / 保温壶"></label>
        <label>大小<input class="i-size" type="number" min="0" step="1" placeholder="10"></label>
      </div>
      <div class="field">
        <label>备注（可选）<input class="i-note" type="text" placeholder="左上角 / 箱内"></label>
      </div>
      <div class="photo i-ph"><span class="muted">无物品照片</span></div>
      <div class="actions">
        <label class="btn ghost">物品照片<input class="i-photo" type="file" accept="image/*" capture="environment" hidden></label>
        <button class="btn ghost i-clear">清除</button>
        <div class="sp"></div>
        <button class="btn primary i-add">保存物品</button>
      </div>

      <div class="field" style="margin-top:10px"><strong>物品列表</strong></div>
      <div class="inv i-list muted">暂无</div>

      <div class="actions" style="margin-top:10px">
        <button class="btn primary btn-save">保存桌子</button>
        <button class="btn" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">删除桌子</button>
      </div>
    `;

    // 名称/容量/备注
    box.querySelector('.in-name').onchange = (e)=>{ t.name = e.target.value.trim()||t.name; save(); renderList(); };
    box.querySelector('.in-cap').onchange = (e)=>{
      t.capacity = Math.max(0, Number(e.target.value||0));
      box.querySelector('.in-rem').value = remainingOf(t);
      save(); renderList();
    };
    box.querySelector('.in-notes').onchange = (e)=>{ t.notes = e.target.value.trim(); save(); renderList(); };

    // 标签
    const tagBox = box.querySelector('.tag-box');
    const tagInput = box.querySelector('.tag-input');
    tagInput.addEventListener('keydown', e=>{
      if(e.key==='Enter' && e.target.value.trim()){
        t.tags = t.tags||[]; t.tags.push(e.target.value.trim());
        e.target.value=''; save(); tagBox.innerHTML = renderTagsHtml(t.tags); bindTagDeletes(t, tagBox); renderList();
      }
    });
    bindTagDeletes(t, tagBox);

    // 桌面照片
    const tp = box.querySelector('.in-photo');
    if(tp){ tp.addEventListener('change', async ev=>{
      const f=ev.target.files?.[0]; if(!f) return;
      try{ t.tablePhoto = await compressImage(f); save(); renderRowEditor(t, box); renderList(); }catch{}
    });}
    const clr = box.querySelector('.btn-clear-photo');
    if(clr){ clr.onclick = ()=>{ t.tablePhoto=null; try{ localStorage.removeItem('photo:table:'+t.id);}catch{}; save(); renderRowEditor(t, box); renderList(); }; }

    // 物品：照片 + 添加
    let itemPhoto = null;
    const iph = box.querySelector('.i-ph');
    const iphInput = box.querySelector('.i-photo');
    iphInput.addEventListener('change', async ev=>{
      const f=ev.target.files?.[0]; if(!f) return;
      try{ itemPhoto=await compressImage(f); iph.innerHTML = `<img src="${itemPhoto}">`; }catch{}
    });
    box.querySelector('.i-clear').onclick = ()=>{ itemPhoto=null; iph.innerHTML='<span class="muted">无物品照片</span>'; };

    box.querySelector('.i-add').onclick = ()=>{
      const name = box.querySelector('.i-name').value.trim();
      const size = Number(box.querySelector('.i-size').value||0);
      const note = box.querySelector('.i-note').value.trim();
      if(!name){ alert('请输入物品名'); return; }
      if(size<0){ alert('大小需≥0'); return; }
      const remNow = remainingOf(t);
      if(size>remNow && !confirm(`大小 ${size} 超过剩余 ${remNow}，仍要添加？`)) return;
      const en = { id:eid(), name, size, note, photo:itemPhoto||null, addedAt:Date.now() };
      t.entries.unshift(en);
      if(en.photo){ try{ localStorage.setItem('photo:entry:'+en.id, en.photo);}catch{} }
      // 清空表单
      box.querySelector('.i-name').value=''; box.querySelector('.i-size').value=''; box.querySelector('.i-note').value=''; itemPhoto=null; iph.innerHTML='<span class="muted">无物品照片</span>';
      // 更新剩余
      box.querySelector('.in-rem').value = remainingOf(t);
      save(); renderInvMiniList(t, box.querySelector('.i-list')); renderList();
    };

    // 物品列表
    renderInvMiniList(t, box.querySelector('.i-list'));

    // 保存/删除
    box.querySelector('.btn-save').onclick = ()=>{ save(); renderList(); };
    box.querySelector('.actions .btn:last-child').onclick = ()=>{
      if(!confirm(`删除 ${t.name}?`)) return;
      (t.entries||[]).forEach(en=>{ try{ localStorage.removeItem('photo:entry:'+en.id);}catch{} });
      try{ localStorage.removeItem('photo:table:'+t.id);}catch{}
      data.tables = data.tables.filter(x=>x.id!==t.id);
      if(openId===t.id) openId=null;
      save(); renderList();
    };
  }

  function renderTagsHtml(tags){
    if(!tags || !tags.length) return '<span class="muted">None</span>';
    return tags.map((t,i)=>`<span class="chip">${escape(t)}<span class="x" data-idx="${i}">×</span></span>`).join(' ');
  }
  function bindTagDeletes(t, tagBox){
    tagBox.querySelectorAll('.x').forEach(x=>{
      x.onclick = ()=>{
        const idx = Number(x.dataset.idx);
        t.tags.splice(idx,1); save(); tagBox.innerHTML = renderTagsHtml(t.tags); bindTagDeletes(t, tagBox); renderList();
      };
    });
  }

  function renderInvMiniList(t, container){
    container.innerHTML='';
    const arr=t.entries||[];
    if(!arr.length){ container.textContent='暂无'; container.classList.add('muted'); return; }
    container.classList.remove('muted');
    arr.forEach(en=>{
      const row=document.createElement('div'); row.className='inv-card';
      row.innerHTML = `
        <div class="inv-thumb">${en.photo?`<img src="${en.photo}">`:'<span class="muted">No</span>'}</div>
        <div>
          <div><b>${escape(en.name)}</b> <span class="tag">Size ${Number(en.size||0)}</span></div>
          <div class="muted" style="max-width:210px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escape(en.note||'')}</div>
          <div class="muted" style="font-size:12px">${new Date(en.addedAt).toLocaleString()}</div>
        </div>
        <div class="sp"></div>
        <button class="btn btn-del" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">删除</button>
      `;
      row.querySelector('.btn-del').onclick = ()=>{
        t.entries = t.entries.filter(x=>x.id!==en.id);
        try{ localStorage.removeItem('photo:entry:'+en.id);}catch{}
        save(); renderInvMiniList(t, container);
        // 同步更新剩余
        const ex = container.closest('.expander');
        if(ex){ const remInput = ex.querySelector('.in-rem'); if(remInput) remInput.value = remainingOf(t); }
        renderList();
      };
      container.appendChild(row);
    });
  }

  // ======= toolbar =======
  function bindToolbar(){
    $('#addTable').onclick = ()=>{
      const t=newTable('Custom '+(data.tables.length+1));
      data.tables.unshift(t); save(); openId=t.id; renderList();
      // 滚到顶部可见
      setTimeout(()=> list.firstElementChild?.scrollIntoView({behavior:'smooth', block:'start'}), 0);
    };
    $('#addPair').onclick = ()=>{
      const n=nextAvailableNumber();
      if(n==null){ alert('有效编号（不含4/7）已用完'); return; }
      const left=newTable(`${n} Left`), right=newTable(`${n} Right`);
      data.tables.unshift(right); data.tables.unshift(left);
      save(); openId=left.id; renderList();
    };

    const q=$('#q'), need=$('#need'), find=$('#find'), clear=$('#clear');
    const run=()=>{
      const kw=(q.value||'').trim().toLowerCase();
      const req=Number(need.value||0);
      const out = data.tables.filter(t=>{
        const textHit = !kw ||
          (t.name||'').toLowerCase().includes(kw) || (t.notes||'').toLowerCase().includes(kw) ||
          (t.tags||[]).some(x=>String(x).toLowerCase().includes(kw)) ||
          (t.entries||[]).some(en=> String(en.name||'').toLowerCase().includes(kw) || String(en.note||'').toLowerCase().includes(kw));
        const spaceHit = isNaN(req) || req<=0 || remainingOf(t)>=req;
        return textHit && spaceHit;
      });
      openId = null; // 搜索结果不保留展开
      renderList(out);
    };
    find.onclick=run;
    q.addEventListener('keydown',e=>{ if(e.key==='Enter') run(); });
    need.addEventListener('keydown',e=>{ if(e.key==='Enter') run(); });
    clear.onclick=()=>{ q.value=''; need.value=''; openId=null; renderList(); };
  }

  // helpers
  function escape(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
  function escapeAttr(s){return escape(s).replace(/"/g,'&quot;')}
  function compressImage(file,{maxW=1280,maxH=1280,quality=0.82}={}){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>{ const img=new Image(); img.onload=()=>{
          const w=img.naturalWidth||img.width,h=img.naturalHeight||img.height;
          const ratio=Math.min(1,maxW/w,maxH/h), cw=Math.max(1,Math.round(w*ratio)), ch=Math.max(1,Math.round(h*ratio));
          const c=document.createElement('canvas'); c.width=cw; c.height=ch; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
          try{ resolve(c.toDataURL('image/jpeg',quality)); }catch(e){ reject(e); }
        }; img.onerror=reject; img.src=r.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }

  // numbering (for Add Pair)
  function parseNumberAndSide(name){ const m=String(name||'').trim().match(/^(\d{1,2})\s+(left|right)$/i); return m?{num:parseInt(m[1],10),side:m[2].toLowerCase()}:null; }
  function isValidNumber(n){ return n>=1 && n<=88 && !/[47]/.test(String(n).padStart(2,'0')); }
  function nextAvailableNumber(){
    const used=new Map();
    for(const t of data.tables){ const p=parseNumberAndSide(t.name); if(!p || !isValidNumber(p.num)) continue; if(!used.has(p.num)) used.set(p.num,new Set()); used.get(p.num).add(p.side); }
    for(let n=1;n<=88;n++){ if(!isValidNumber(n)) continue; const s=used.get(n); if(!s || s.size<2) return n; }
    return null;
  }
})();
</script>
</body>
</html>
