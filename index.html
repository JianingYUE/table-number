<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive 2D Table Map</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff; --good:#38d39f; --warn:#ffb86b; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{
      position:sticky;top:0;z-index:5;background:rgba(13,17,23,.9);backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid #202632;display:flex;gap:.75rem;align-items:center;padding:.6rem .9rem
    }
    header .title{font-weight:700;letter-spacing:.2px;margin-right:.5rem}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .toolbar input[type="text"]{min-width:230px}
    .btn, input[type="file"]::file-selector-button, .chip{border:1px solid #303845;background:#12161b;color:var(--text);padding:.45rem .7rem;border-radius:.8rem;cursor:pointer}
    .btn:hover{border-color:#3a4556}
    .btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
    .btn.ghost{background:transparent}
    .btn.warn{background:#312312;border-color:#5a3b13;color:#ffcc88}
    input[type="text"], textarea, select{background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.5rem .6rem;outline:none}
    textarea{min-height:84px;resize:vertical}

    .wrap{display:grid;grid-template-columns: 1fr 360px;gap:0;border-top:1px solid #161b22;min-height:calc(100vh - 56px)}
    .panel{border-left:1px solid #202632;background:#0d1117;position:relative}

    /* Map area */
    #stage{position:relative;overflow:auto;background:#0b0e13}
    .board{position:relative;margin:16px;border:1px solid #202632;border-radius:16px;min-height:70vh;background:#0c1016;
      background-size:contain;background-repeat:no-repeat;background-position:center}
    #grid{position:absolute;inset:0;pointer-events:none;background-image: radial-gradient(circle at 1px 1px,#1a2230 1px,transparent 0);
      background-size:20px 20px;opacity:.35}

    .table-marker{position:absolute;min-width:50px;min-height:50px;display:flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:14px;border:1px solid #2a3240;background:#10151c;box-shadow:0 4px 16px rgba(0,0,0,.35);
      cursor:pointer;user-select:none;transition:transform .15s ease, box-shadow .15s ease, border-color .2s}
    .table-marker:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.45)}
    .table-marker.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,166,255,.25)}
    .table-badge{font-weight:700;border-radius:10px;padding:.1rem .45rem;margin-right:.4rem;background:#152032;border:1px solid #243042}
    .marker-name{font-weight:600;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pulse{box-shadow:0 0 0 2px rgba(56,211,159,.2),0 0 0 6px rgba(56,211,159,.08)}
    .drag-handle{position:absolute;inset:-6px; border:2px dashed #304055; border-radius:16px; display:none}
    .table-marker.dragging .drag-handle{display:block}

    /* Side editor */
    .panel h3{margin:16px;font-size:16px}
    .form{display:flex;flex-direction:column;gap:.6rem;padding:0 16px 16px}
    .form .row{display:grid;grid-template-columns:1fr;gap:.5rem}
    .photo{width:100%;aspect-ratio: 4/3; background:#0f1318;border:1px dashed #344055;border-radius:12px;display:grid;place-items:center;overflow:hidden}
    .photo img{width:100%;height:100%;object-fit:cover}

    .items{display:flex;flex-wrap:wrap;gap:.4rem}
    .chip{display:inline-flex;gap:.35rem;align-items:center}
    .chip .x{font-weight:700;opacity:.7}
    .muted{color:var(--muted)}

    .list{max-height:220px;overflow:auto;border-top:1px solid #202632;padding:8px 16px}
    .list .match{padding:6px 8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;border:1px solid #243042;margin-bottom:6px}

    .foot{position:absolute;bottom:0;left:0;right:0;padding:10px 16px;border-top:1px solid #202632;display:flex;gap:.5rem}
    .foot .sp{flex:1}

    .hint{padding:10px 16px;color:#a6b2c0;border-top:1px solid #202632}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;background:#12161b;padding:.1rem .35rem;border-radius:6px;border:1px solid #202632}

    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
      .panel{order:-1;height:460px}
      .board{min-height:55vh}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">ğŸ—ºï¸ 2D Floor Map Â· Clickable Tables</div>
    <div class="toolbar">
      <label class="btn ghost">ä¸Šä¼ å¹³é¢å›¾<input id="bgFile" type="file" accept="image/*" hidden></label>
      <button id="addTableBtn" class="btn">æ·»åŠ æ¡Œå­</button>
      <button id="toggleEditBtn" class="btn warn" title="æ‹–åŠ¨æ ‡è®°ä»¥è°ƒæ•´ä½ç½®">å¸ƒå±€æ¨¡å¼ï¼šå…³é—­</button>
      <input id="search" type="text" placeholder="æœç´¢ç‰©å“/æ¡Œå·/å¤‡æ³¨â€¦ (å›è½¦å®šä½)" />
      <button id="clearSearch" class="btn ghost">æ¸…é™¤</button>
      <button id="exportBtn" class="btn ghost">å¯¼å‡º</button>
      <label class="btn ghost">å¯¼å…¥<input id="importFile" type="file" accept="application/json" hidden></label>
      <button id="resetBtn" class="btn ghost" title="æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆä¿ç•™èƒŒæ™¯ï¼‰">é‡ç½®</button>
    </div>
  </header>

  <div class="wrap">
    <main id="stage">
      <div id="board" class="board">
        <div id="grid"></div>
        <!-- markers injected here -->
      </div>
    </main>

    <aside class="panel" id="editor">
      <h3>æ¡Œå­ä¿¡æ¯</h3>
      <div class="form">
        <div class="row"><label>æ¡Œå· / åç§°<input id="f-name" type="text" placeholder="ä¾‹å¦‚ï¼šT8 æˆ– åŒ…å¢ A"/></label></div>
        <div class="row"><label>å¤‡æ³¨<textarea id="f-notes" placeholder="è¿™é‡Œå¯å†™å†…éƒ¨è¯´æ˜ã€ç‰¹æ®Šéœ€æ±‚ç­‰"></textarea></label></div>
        <div class="row">
          <label>ç‰©å“ï¼ˆè¾“å…¥åå›è½¦æ·»åŠ ï¼‰<input id="f-itemInput" type="text" placeholder="å¦‚ï¼šç”Ÿæ—¥è›‹ç³•ã€ç›¸æœºã€ä¿æ¸©å£¶" /></label>
          <div id="f-items" class="items muted">æš‚æ— </div>
        </div>
        <div class="row">
          <div class="photo" id="photoBox"><span class="muted">æ— ç…§ç‰‡</span></div>
          <label class="btn ghost" style="width:max-content; margin-top:.4rem">æ›´æ–°ç…§ç‰‡<input id="f-photo" type="file" accept="image/*" hidden></label>
        </div>
      </div>
      <div class="hint">æç¤ºï¼šåœ¨ <span class="kbd">å¸ƒå±€æ¨¡å¼</span> ä¸‹å¯æ‹–åŠ¨æ¡Œå­ã€‚åŒå‡»æ¡Œæ ‡ä¹Ÿå¯å¿«é€Ÿè¿›å…¥ç¼–è¾‘ã€‚</div>
      <div class="foot">
        <button id="saveBtn" class="btn primary">ä¿å­˜</button>
        <button id="deleteBtn" class="btn" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">åˆ é™¤æ¡Œå­</button>
        <div class="sp"></div>
        <button id="closeBtn" class="btn ghost">æ”¶èµ·</button>
      </div>

      <div class="list" id="resultList"></div>
    </aside>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const board = $('#board');
  const editor = $('#editor');
  const stateKey = 'tableMapState.v1';
  const bgKey = 'tableMapBG.v1';
  let data = load() || seed();
  let selectedId = null;
  let editMode = false;

  // ----- init -----
  renderBackground();
  renderAll();
  bindToolbar();
  bindEditor();

  function uid(){return 't' + Math.random().toString(36).slice(2,9)}

  function seed(){
    // Generate tables 1â€“88, excluding any number containing 4 or 7 in either digit
    // Each table has LEFT/RIGHT sides â†’ åç§°å½¢å¦‚ â€œ12å·¦/12å³â€
    const tables = [];

    // layout grid config
    const startX = 80;     // left padding
    const startY = 80;     // top padding
    const cellW  = 140;    // horizontal spacing between numbers (not L/R)
    const cellH  = 110;    // vertical spacing
    const cols   = 8;      // numbers per row (each number occupies one cell; L/R within the cell)

    const isValid = (n)=> !/[47]/.test(String(n).padStart(2,'0')); // no 4 or 7 in tens or ones

    let index = 0; // counts valid numbers
    for(let n=1; n<=88; n++){
      if(!isValid(n)) continue;
      const row = Math.floor(index / cols);
      const col = index % cols;
      const baseX = startX + col*cellW;
      const baseY = startY + row*cellH;
      // left/right markers inside the same cell (slight offset)
      tables.push({id:uid(), x:baseX-26, y:baseY, name:`${n}å·¦`, notes:'', items:[], photo:null});
      tables.push({id:uid(), x:baseX+26, y:baseY, name:`${n}å³`, notes:'', items:[], photo:null});
      index++;
    }
    return { tables };
  }

  function save(){localStorage.setItem(stateKey, JSON.stringify(data))}
  function load(){try{ return JSON.parse(localStorage.getItem(stateKey)) }catch{return null}}

  function setBackground(dataUrl){
    if(dataUrl){ localStorage.setItem(bgKey, dataUrl); board.style.backgroundImage = `url(${dataUrl})`; }
  }
  function renderBackground(){
    const bg = localStorage.getItem(bgKey);
    if(bg){ board.style.backgroundImage = `url(${bg})` }
  }

  // ----- render markers -----
  function renderAll(){
    board.querySelectorAll('.table-marker').forEach(n=>n.remove());
    data.tables.forEach(t=> board.appendChild(markerNode(t)) );
  }

  function markerNode(t){
    const el = document.createElement('div');
    el.className = 'table-marker';
    el.style.left = (t.x||0) + 'px';
    el.style.top  = (t.y||0) + 'px';
    el.dataset.id = t.id;
    el.innerHTML = `<span class="table-badge"></span><span class="marker-name"></span><div class="drag-handle"></div>`;
    el.querySelector('.table-badge').textContent = t.name || 'T?';
    el.querySelector('.marker-name').textContent = (t.items?.[0] || t.notes || '').slice(0,22);

    el.addEventListener('click', (e)=>{
      if(editMode) return; // avoid click while dragging
      select(t.id);
      openEditor(t.id);
    });
    el.addEventListener('dblclick', ()=> openEditor(t.id));

    // drag position in edit mode
    let drag = {active:false, dx:0, dy:0};
    el.addEventListener('pointerdown', (e)=>{
      if(!editMode) return; drag.active=true; el.classList.add('dragging');
      drag.dx = e.clientX - el.offsetLeft; drag.dy = e.clientY - el.offsetTop; el.setPointerCapture(e.pointerId);
    });
    el.addEventListener('pointermove', (e)=>{
      if(!drag.active) return; const nx = e.clientX - drag.dx; const ny = e.clientY - drag.dy; el.style.left = nx+ 'px'; el.style.top = ny + 'px';
    });
    el.addEventListener('pointerup', (e)=>{
      if(!drag.active) return; drag.active=false; el.classList.remove('dragging');
      const tObj = data.tables.find(x=>x.id===t.id); tObj.x = el.offsetLeft; tObj.y = el.offsetTop; save();
    });

    return el;
  }

  function select(id){
    selectedId = id; $$('.table-marker').forEach(n=>n.classList.toggle('selected', n.dataset.id===id));
  }

  // ----- editor -----
  function openEditor(id){
    select(id);
    const t = data.tables.find(x=>x.id===id);
    $('#f-name').value = t.name || '';
    $('#f-notes').value = t.notes || '';
    renderItems(t.items);
    renderPhoto(t.photo);
  }
  function renderItems(items){
    const box = $('#f-items'); box.innerHTML='';
    if(!items || items.length===0){ box.textContent='æš‚æ— '; box.classList.add('muted'); return }
    box.classList.remove('muted');
    items.forEach((txt,i)=>{
      const chip = document.createElement('div'); chip.className='chip'; chip.innerHTML = `<span>${escapeHTML(txt)}</span><span class="x" title="ç§»é™¤">Ã—</span>`;
      chip.querySelector('.x').onclick = ()=>{ const t = current(); t.items.splice(i,1); renderItems(t.items); save(); }
      box.appendChild(chip);
    });
  }
  function renderPhoto(photo){
    const box = $('#photoBox'); box.innerHTML='';
    if(photo){ const img = new Image(); img.src = photo; box.appendChild(img); }
    else { box.innerHTML = '<span class="muted">æ— ç…§ç‰‡</span>'; }
  }
  function current(){ return data.tables.find(x=>x.id===selectedId) }

  function bindEditor(){
    $('#f-itemInput').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && e.target.value.trim()){
        const t = current(); if(!t) return; t.items = t.items || []; t.items.push(e.target.value.trim()); e.target.value=''; renderItems(t.items); save();
      }
    });
    $('#f-photo').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return; const reader = new FileReader(); reader.onload = ()=>{ const t = current(); if(!t) return; t.photo = reader.result; renderPhoto(t.photo); save(); };
      reader.readAsDataURL(file);
    });
    $('#saveBtn').onclick = ()=>{
      const t = current(); if(!t) return; t.name = $('#f-name').value.trim()||t.name; t.notes = $('#f-notes').value.trim();
      // update marker label
      const node = board.querySelector(`.table-marker[data-id="${t.id}"]`);
      node?.querySelector('.table-badge')?.replaceChildren(document.createTextNode(t.name||'T?'));
      node?.querySelector('.marker-name')?.replaceChildren(document.createTextNode((t.items?.[0]||t.notes||'').slice(0,22)));
      save();
      flash(node);
    };
    $('#deleteBtn').onclick = ()=>{
      const t = current(); if(!t) return; if(!confirm(`åˆ é™¤ ${t.name || 'è¯¥æ¡Œå­'} ï¼Ÿ`)) return;
      data.tables = data.tables.filter(x=>x.id!==t.id); save(); renderAll(); selectedId=null;
    };
    $('#closeBtn').onclick = ()=>{ selectedId=null; $$('.table-marker').forEach(n=>n.classList.remove('selected')) };
  }

  function flash(node){ if(!node) return; node.classList.add('pulse'); setTimeout(()=> node.classList.remove('pulse'), 600) }

  // ----- toolbar -----
  function bindToolbar(){
    $('#addTableBtn').onclick = ()=>{
      const id = uid(); const t = {id,name:`T${data.tables.length+1}`,x:Math.round(board.clientWidth/2-40+Math.random()*60),y:80+Math.round(Math.random()*40),notes:'',items:[],photo:null};
      data.tables.push(t); save(); renderAll(); select(id); openEditor(id);
    };
    $('#toggleEditBtn').onclick = ()=>{
      editMode = !editMode; $('#toggleEditBtn').textContent = `å¸ƒå±€æ¨¡å¼ï¼š${editMode?'å¼€å¯':'å…³é—­'}`; $('#toggleEditBtn').classList.toggle('warn', !editMode);
      board.classList.toggle('editing', editMode);
    };
    $('#exportBtn').onclick = ()=>{
      const payload = JSON.stringify(data, null, 2);
      const blob = new Blob([payload], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'map-data.json'}); a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    };
    $('#importFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ data = JSON.parse(r.result); save(); renderAll(); alert('å¯¼å…¥æˆåŠŸ'); }catch{ alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼é”™è¯¯') } };
      r.readAsText(f);
    });
    $('#resetBtn').onclick = ()=>{ if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ¡Œå­æ•°æ®ï¼Ÿ')){ data = seed(); save(); renderAll(); }};
    $('#bgFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ setBackground(r.result) }; r.readAsDataURL(f);
    });

    const search = $('#search'); const list = $('#resultList');
    function runSearch(q){
      q = (q||'').trim().toLowerCase(); list.innerHTML=''; $$('.table-marker').forEach(n=> n.classList.remove('pulse'));
      if(!q){ return }
      const matches = data.tables.filter(t=>
        (t.name||'').toLowerCase().includes(q) ||
        (t.notes||'').toLowerCase().includes(q) ||
        (t.items||[]).some(it=> it.toLowerCase().includes(q))
      );
      matches.forEach(t=>{
        const row = document.createElement('div'); row.className='match';
        row.innerHTML = `<div><b>${escapeHTML(t.name)}</b><div class="muted" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHTML((t.items||[]).join(', ')||t.notes||'')}</div></div><button class="btn">å®šä½</button>`;
        row.querySelector('button').onclick = ()=> focusTable(t.id);
        list.appendChild(row);
      });
      // highlight all matching
      matches.forEach(t=> flash(board.querySelector(`.table-marker[data-id="${t.id}"]`)) );
    }
    search.addEventListener('keydown', (e)=>{ if(e.key==='Enter') runSearch(search.value) });
    $('#clearSearch').onclick = ()=>{ search.value=''; list.innerHTML=''; $$('.table-marker').forEach(n=> n.classList.remove('pulse')) };

    function focusTable(id){
      const node = board.querySelector(`.table-marker[data-id="${id}"]`); if(!node) return;
      const rect = node.getBoundingClientRect(); const parent = board.getBoundingClientRect();
      board.scrollTo({ left: node.offsetLeft - parent.width/2 + rect.width/2, top: node.offsetTop - parent.height/2 + rect.height/2, behavior:'smooth' });
      flash(node); select(id); openEditor(id);
    }
  }

  function escapeHTML(s){return (s??'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}
})();
</script>
</body>
</html>
