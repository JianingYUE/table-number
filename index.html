<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory – Bar View</title>
<style>
:root{
  --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff;
  --bar-bg:#1a2230; --bar-rem:#38d39f; --bar-used:#2a3344;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:rgba(13,17,23,.92);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #202632}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.6rem .9rem}
.btn, input[type="file"]::file-selector-button, .chip{border:1px solid #303845;background:#12161b;color:var(--text);padding:.48rem .7rem;border-radius:.8rem;cursor:pointer}
.btn:hover{border-color:#3a4556}
.btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
.btn.ghost{background:transparent}
.btn.warn{background:#312312;border-color:#5a3b13;color:#ffcc88}
input[type="text"],input[type="number"],textarea{background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.55rem .6rem;outline:none}
textarea{min-height:84px;resize:vertical}

.wrap{display:grid;grid-template-columns:1.2fr .9fr;gap:0;min-height:calc(100vh - 56px)}
.main{padding:10px}
.panel{border-left:1px solid #202632;background:#0d1117;position:relative}

.card{background:linear-gradient(180deg,#11151b,#0f1319);border:1px solid #1f2631;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
.list{display:flex;flex-direction:column;gap:10px}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px}
.row + .row{border-top:1px solid #1c2430}
.title{font-weight:700}
.muted{color:var(--muted)}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#12161b;padding:.1rem .35rem;border-radius:6px;border:1px solid #202632}

.bar{position:relative;height:14px;background:var(--bar-bg);border-radius:999px;overflow:hidden}
.bar .used{position:absolute;inset:0 0 0 auto;background:var(--bar-used)}
.bar .rem{position:absolute;inset:0 auto 0 0;background:var(--bar-rem)}
.badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;background:#152032;border:1px solid #243042;font-weight:700}

.table-row{display:grid;grid-template-columns: minmax(120px, 220px) 1fr max-content;gap:12px;align-items:center;padding:12px}
.table-row:hover{background:#0e1319}
.table-row .meta{display:flex;gap:8px;align-items:center}
.table-row .sub{color:var(--muted);font-size:12px}
.table-row .stat{white-space:nowrap}

.photo{width:100%;aspect-ratio:4/3;background:#0f1318;border:1px dashed #344055;border-radius:12px;display:grid;place-items:center;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover}

.panel h3{margin:16px}
.form{display:flex;flex-direction:column;gap:.6rem;padding:0 16px 16px}
.chips{display:flex;flex-wrap:wrap;gap:.4rem}
.chip .x{font-weight:700;opacity:.7}

.inv{border-top:1px solid #202632;margin-top:6px;padding:8px 16px;max-height:220px;overflow:auto}
.inv-card{display:flex;gap:.6rem;align-items:center;border:1px solid #243042;border-radius:10px;padding:6px 8px;margin-bottom:8px}
.inv-thumb{width:56px;height:42px;flex:0 0 56px;background:#0f1318;border:1px solid #2a3240;border-radius:8px;overflow:hidden;display:grid;place-items:center}
.inv-thumb img{width:100%;height:100%;object-fit:cover}
.tag{display:inline-block;background:#152032;border:1px solid #243042;padding:.1rem .4rem;border-radius:999px;font-weight:600}

.foot{position:absolute;left:0;right:0;bottom:0;padding:10px 16px;border-top:1px solid #202632;display:flex;gap:.5rem}
.foot .sp{flex:1}

/* mobile */
.mobile-toggle{display:none}
@media (max-width: 900px){
  .wrap{grid-template-columns:1fr}
  .panel{position:fixed;left:0;right:0;bottom:0;height:68vh;border-left:none;border-top:1px solid #202632;border-radius:16px 16px 0 0;transform:translateY(100%);transition:transform .25s ease;z-index:6;background:#0d1117}
  .panel.open{transform:translateY(0)}
  .mobile-toggle{display:block;position:fixed;right:12px;bottom:12px;z-index:7}
}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="addTable" class="btn">Add Table</button>
    <button id="addPair" class="btn">Add Pair</button>
    <input id="q" type="text" placeholder="搜索物品/桌名/备注…" />
    <input id="need" type="number" min="0" step="1" style="width:120px" placeholder="需要空间" />
    <button id="find" class="btn ghost">Find</button>
    <button id="clear" class="btn ghost">Clear</button>
    <div class="sp"></div>
    <span class="muted">绿色表示剩余空间</span>
  </div>
</header>

<div class="wrap">
  <main class="main">
    <div class="card">
      <div id="tableList" class="list"></div>
    </div>
  </main>

  <aside id="editor" class="panel">
    <h3>Table</h3>
    <div class="form">
      <label>名称<input id="f-name" type="text" placeholder="12 Left / A 区"></label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
        <label>总容量<input id="f-cap" type="number" min="0" step="1" placeholder="100"></label>
        <label>剩余<input id="f-rem" type="number" disabled></label>
      </div>
      <label>备注<textarea id="f-notes" placeholder="例如：上层/有电源/加锁等"></textarea></label>

      <div class="photo" id="t-photoBox"><span class="muted">无桌面照片</span></div>
      <div style="display:flex;gap:.5rem;align-items:center">
        <label class="btn ghost">桌面照片<input id="t-photo" type="file" accept="image/*" hidden></label>
        <button id="t-photo-clear" class="btn ghost">清除</button>
      </div>

      <label>标签（回车添加）<input id="f-tagInput" type="text" placeholder="Fragile, VIP"></label>
      <div id="f-tags" class="chips muted">None</div>

      <hr style="border:none;border-top:1px solid #202632">
      <strong>添加物品</strong>
      <label>物品名<input id="i-name" type="text" placeholder="相机 / 生日蛋糕 / 保温壶"></label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
        <label>大小<input id="i-size" type="number" min="0" step="1" placeholder="10"></label>
        <label>备注（可选）<input id="i-note" type="text" placeholder="左上角 / 箱内"></label>
      </div>
      <div class="photo" id="i-photoBox"><span class="muted">无物品照片</span></div>
      <div style="display:flex;gap:.5rem;align-items:center">
        <label class="btn ghost">物品照片<input id="i-photo" type="file" accept="image/*" hidden></label>
        <button id="i-photo-clear" class="btn ghost">清除</button>
        <div class="sp"></div>
        <button id="i-add" class="btn primary">保存物品</button>
      </div>

      <strong style="margin-top:6px">物品列表</strong>
      <div id="invList" class="inv muted">暂无</div>
    </div>

    <div class="foot">
      <button id="saveTable" class="btn primary">保存桌子</button>
      <button id="deleteTable" class="btn" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">删除桌子</button>
      <div class="sp"></div>
      <button id="closePanel" class="btn ghost">关闭</button>
    </div>
  </aside>
</div>

<button id="togglePanel" class="btn primary mobile-toggle" aria-expanded="false">编辑</button>

<script>
(function(){
  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const list = $('#tableList'), panel = $('#editor'), toggleBtn = $('#togglePanel');
  const stateKey='bar.inv.v1';
  let data = load() || seed();
  let selectedId=null;

  // init
  renderList(); bindToolbar(); bindPanel();

  // ======= data model =======
  function uid(){ return 't'+Math.random().toString(36).slice(2,9) }
  function eid(){ return 'e'+Math.random().toString(36).slice(2,9) }
  function newTable(name){ return {id:uid(), name, notes:'', tags:[], capacity:100, entries:[], tablePhoto:null}; }
  function remainingOf(t){ const used=(t.entries||[]).reduce((s,e)=>s+Number(e.size||0),0); return Math.max(0, Number(t.capacity||0)-used); }

  function seed(){
    // 生成 1–88, 过滤含 4/7 的号，每个号 Left/Right
    const tables=[]; const isValid=n=>!/[47]/.test(String(n).padStart(2,'0'));
    for(let n=1;n<=88;n++){ if(!isValid(n)) continue; tables.push(newTable(`${n} Left`)); tables.push(newTable(`${n} Right`)); }
    return {tables};
  }

  // ======= storage (split photos) =======
  function save(){
    try{
      const slim={tables:data.tables.map(t=>{
        if(t.tablePhoto){ try{ localStorage.setItem('photo:table:'+t.id, t.tablePhoto);}catch(e){} }
        (t.entries||[]).forEach(en=>{ if(en.photo){ try{ localStorage.setItem('photo:entry:'+en.id, en.photo);}catch(e){} }});
        const {tablePhoto, entries, ...rest}=t;
        const es=(entries||[]).map(en=>{ const {photo,...r}=en; return r; });
        return {...rest, entries:es};
      })};
      localStorage.setItem(stateKey, JSON.stringify(slim));
      return true;
    }catch(e){
      alert('保存失败：浏览器存储已满或被阻止。可尝试清除旧照片。'); return false;
    }
  }
  function load(){
    try{
      const raw=localStorage.getItem(stateKey); if(!raw) return null;
      const slim=JSON.parse(raw);
      const tables=(slim.tables||[]).map(t=>{
        const tablePhoto=localStorage.getItem('photo:table:'+t.id)||null;
        const entries=(t.entries||[]).map(en=>({...en, photo:localStorage.getItem('photo:entry:'+en.id)||null}));
        return {...t, tablePhoto, entries};
      });
      return {tables};
    }catch{ return null }
  }

  // ======= list render (bar view) =======
  function renderList(items=data.tables){
    list.innerHTML='';
    if(!items.length){ list.innerHTML='<div class="row"><span class="muted">暂无桌子</span></div>'; return; }

    items.forEach(t=>{
      const rem=remainingOf(t), cap=Number(t.capacity||0), used=Math.max(0, cap-rem);
      const pct = cap>0 ? (rem/cap)*100 : 0;

      const row = document.createElement('div');
      row.className='table-row';
      row.innerHTML = `
        <div class="meta">
          <span class="badge">${escape(t.name||'T?')}</span>
          <span class="sub">${escape(t.entries?.[0]?.name || t.notes || '…')}</span>
        </div>
        <div>
          <div class="bar">
            <div class="rem" style="width:${pct}%;"></div>
            <div class="used" style="width:${100-pct}%"></div>
          </div>
        </div>
        <div class="stat">${rem}/${cap}</div>
      `;
      row.addEventListener('click', ()=>{ openPanel(t.id); });
      list.appendChild(row);
    });
  }

  // ======= toolbar =======
  function bindToolbar(){
    $('#addTable').onclick = ()=>{
      const t=newTable('Custom '+(data.tables.length+1));
      data.tables.unshift(t); save(); renderList(); openPanel(t.id);
    };
    $('#addPair').onclick = ()=>{
      const n=nextAvailableNumber();
      if(n==null){ alert('有效编号（不含4/7）已用完'); return; }
      const left=newTable(`${n} Left`), right=newTable(`${n} Right`);
      data.tables.unshift(right); data.tables.unshift(left);
      save(); renderList(); openPanel(left.id);
    };

    const q=$('#q'), need=$('#need'), find=$('#find'), clear=$('#clear');
    const run=()=>{
      const kw=(q.value||'').trim().toLowerCase();
      const req=Number(need.value||0);
      const out = data.tables.filter(t=>{
        const textHit = !kw ||
          (t.name||'').toLowerCase().includes(kw) || (t.notes||'').toLowerCase().includes(kw) ||
          (t.tags||[]).some(x=>String(x).toLowerCase().includes(kw)) ||
          (t.entries||[]).some(en=> String(en.name||'').toLowerCase().includes(kw) || String(en.note||'').toLowerCase().includes(kw));
        const spaceHit = isNaN(req) || req<=0 || remainingOf(t)>=req;
        return textHit && spaceHit;
      });
      renderList(out);
    };
    find.onclick=run;
    q.addEventListener('keydown',e=>{ if(e.key==='Enter') run(); });
    need.addEventListener('keydown',e=>{ if(e.key==='Enter') run(); });
    clear.onclick=()=>{ q.value=''; need.value=''; renderList(); };
  }

  // ======= editor panel =======
  function openPanel(id){
    selectedId=id;
    const t = data.tables.find(x=>x.id===id); if(!t) return;
    $('#f-name').value=t.name||'';
    $('#f-notes').value=t.notes||'';
    $('#f-cap').value=Number(t.capacity||0);
    $('#f-rem').value=remainingOf(t);
    renderTags(t.tags||[]);
    renderTablePhoto(t.tablePhoto);
    renderInvList(t);
    // reset item form
    $('#i-name').value=''; $('#i-size').value=''; $('#i-note').value=''; renderItemPhoto(null);
    if (window.matchMedia('(max-width: 900px)').matches) {
      panel.classList.add('open'); toggleBtn.setAttribute('aria-expanded','true'); toggleBtn.textContent='隐藏';
    }
  }
  function closePanel(){
    panel.classList.remove('open'); toggleBtn.setAttribute('aria-expanded','false'); toggleBtn.textContent='编辑';
  }
  toggleBtn.onclick = ()=> panel.classList.toggle('open');

  function bindPanel(){
    $('#saveTable').onclick=()=>{
      const t = data.tables.find(x=>x.id===selectedId); if(!t) return;
      t.name=$('#f-name').value.trim()||t.name;
      t.notes=$('#f-notes').value.trim();
      t.capacity=Math.max(0, Number($('#f-cap').value||0));
      $('#f-rem').value=remainingOf(t);
      save(); renderList();
    };
    $('#deleteTable').onclick=()=>{
      const t = data.tables.find(x=>x.id===selectedId); if(!t) return;
      if(!confirm(`删除 ${t.name}?`)) return;
      (t.entries||[]).forEach(en=>{ try{ localStorage.removeItem('photo:entry:'+en.id);}catch(e){} });
      try{ localStorage.removeItem('photo:table:'+t.id);}catch(e){}
      data.tables=data.tables.filter(x=>x.id!==t.id); save(); renderList(); closePanel();
    };
    $('#closePanel').onclick=()=> closePanel();

    // tags
    $('#f-tagInput').addEventListener('keydown', e=>{
      if(e.key==='Enter' && e.target.value.trim()){
        const t = data.tables.find(x=>x.id===selectedId); if(!t) return;
        t.tags=t.tags||[]; t.tags.push(e.target.value.trim()); e.target.value=''; save(); renderTags(t.tags); renderList();
      }
    });

    // table photo
    $('#t-photo').addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ const url=await compressImage(f); const t=data.tables.find(x=>x.id===selectedId); if(!t) return; t.tablePhoto=url; save(); renderTablePhoto(url);}
      catch{ alert('桌面照片加载失败'); }
    });
    $('#t-photo-clear').onclick=()=>{
      const t=data.tables.find(x=>x.id===selectedId); if(!t) return;
      t.tablePhoto=null; try{ localStorage.removeItem('photo:table:'+t.id); }catch{}
      save(); renderTablePhoto(null);
    };

    // item photo + add
    let itemPhoto=null;
    $('#i-photo').addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ itemPhoto=await compressImage(f); renderItemPhoto(itemPhoto); }catch{ alert('物品照片加载失败'); }
    });
    $('#i-photo-clear').onclick=()=>{ itemPhoto=null; renderItemPhoto(null); };

    $('#i-add').onclick=()=>{
      const name=$('#i-name').value.trim();
      const size=Number($('#i-size').value||0);
      const note=$('#i-note').value.trim();
      if(!name){ alert('请输入物品名'); return; }
      if(size<0){ alert('大小需≥0'); return; }
      const t=data.tables.find(x=>x.id===selectedId); if(!t) return;
      const rem=remainingOf(t);
      if(size>rem && !confirm(`大小 ${size} 超过剩余 ${rem}，仍要添加？`)) return;
      const entry={id:eid(), name, size, note, photo:itemPhoto||null, addedAt:Date.now()};
      t.entries.unshift(entry);
      if(entry.photo){ try{ localStorage.setItem('photo:entry:'+entry.id, entry.photo);}catch{} }
      $('#i-name').value=''; $('#i-size').value=''; $('#i-note').value=''; itemPhoto=null; renderItemPhoto(null);
      $('#f-rem').value=remainingOf(t);
      save(); renderInvList(t); renderList();
    };
  }

  function renderTags(tags){
    const box=$('#f-tags'); box.innerHTML='';
    if(!tags.length){ box.textContent='None'; box.classList.add('muted'); return; }
    box.classList.remove('muted');
    tags.forEach((txt,i)=>{
      const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML=`<span>${escape(txt)}</span> <span class="x">×</span>`;
      chip.querySelector('.x').onclick=()=>{
        const t=data.tables.find(x=>x.id===selectedId); t.tags.splice(i,1); save(); renderTags(t.tags); renderList();
      };
      box.appendChild(chip);
    });
  }
  function renderTablePhoto(photo){
    const box=$('#t-photoBox'); box.innerHTML='';
    if(photo){ const img=new Image(); img.src=photo; box.appendChild(img); }
    else { box.innerHTML='<span class="muted">无桌面照片</span>'; }
  }
  function renderItemPhoto(photo){
    const box=$('#i-photoBox'); box.innerHTML='';
    if(photo){ const img=new Image(); img.src=photo; box.appendChild(img); }
    else { box.innerHTML='<span class="muted">无物品照片</span>'; }
  }
  function renderInvList(t){
    const box=$('#invList'); box.innerHTML='';
    if(!t.entries?.length){ box.textContent='暂无'; box.classList.add('muted'); return; }
    box.classList.remove('muted');
    t.entries.forEach(en=>{
      const row=document.createElement('div'); row.className='inv-card';
      const th=document.createElement('div'); th.className='inv-thumb';
      if(en.photo){ const im=new Image(); im.src=en.photo; th.appendChild(im); } else { th.innerHTML='<span class="muted">No</span>'; }
      const meta=document.createElement('div');
      meta.innerHTML=`<div><b>${escape(en.name)}</b> <span class="tag">Size ${Number(en.size||0)}</span></div>
        <div class="muted" style="max-width:210px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escape(en.note||'')}</div>
        <div class="muted" style="font-size:12px">${new Date(en.addedAt).toLocaleString()}</div>`;
      const act=document.createElement('div');
      const del=document.createElement('button'); del.className='btn'; del.style.background='#25161a'; del.style.borderColor='#4a2a32'; del.style.color='#ff9aa9'; del.textContent='删除';
      del.onclick=()=>{
        const tv=data.tables.find(x=>x.id===selectedId);
        tv.entries=tv.entries.filter(x=>x.id!==en.id);
        try{ localStorage.removeItem('photo:entry:'+en.id);}catch{}
        save(); $('#f-rem').value=remainingOf(tv); renderInvList(tv); renderList();
      };
      act.appendChild(del);
      row.appendChild(th); row.appendChild(meta); row.appendChild(act); box.appendChild(row);
    });
  }

  // helpers
  function escape(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
  function compressImage(file,{maxW=1280,maxH=1280,quality=0.82}={}){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>{ const img=new Image(); img.onload=()=>{
          const w=img.naturalWidth||img.width,h=img.naturalHeight||img.height;
          const ratio=Math.min(1,maxW/w,maxH/h), cw=Math.max(1,Math.round(w*ratio)), ch=Math.max(1,Math.round(h*ratio));
          const c=document.createElement('canvas'); c.width=cw; c.height=ch; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
          try{ resolve(c.toDataURL('image/jpeg',quality)); }catch(e){ reject(e); }
        }; img.onerror=reject; img.src=r.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }

  // numbering (for Add Pair)
  function parseNumberAndSide(name){ const m=String(name||'').trim().match(/^(\d{1,2})\s+(left|right)$/i); return m?{num:parseInt(m[1],10),side:m[2].toLowerCase()}:null; }
  function isValidNumber(n){ return n>=1 && n<=88 && !/[47]/.test(String(n).padStart(2,'0')); }
  function nextAvailableNumber(){
    const used=new Map();
    for(const t of data.tables){ const p=parseNumberAndSide(t.name); if(!p || !isValidNumber(p.num)) continue; if(!used.has(p.num)) used.set(p.num,new Set()); used.get(p.num).add(p.side); }
    for(let n=1;n<=88;n++){ if(!isValidNumber(n)) continue; const s=used.get(n); if(!s || s.size<2) return n; }
    return null;
  }
})();
</script>
</body>
</html>
