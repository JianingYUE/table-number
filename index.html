<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory – Bar View</title>
<style>
:root{
  --bg:#0b0d10; --card:#12161b; --muted:#8892a6; --text:#e6edf3; --accent:#6aa6ff;
  --bar-bg:#1a2230; --bar-rem:#38d39f; --bar-used:#2a3344;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0c10,#0d1117);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:rgba(13,17,23,.92);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #202632}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.6rem .9rem}
.btn{border:1px solid #303845;background:#12161b;color:var(--text);padding:.48rem .7rem;border-radius:.8rem;cursor:pointer}
.btn:hover{border-color:#3a4556}
.btn.primary{background:linear-gradient(180deg,#2a5fff,#1b50e6);border-color:#2c57d0}
.btn.ghost{background:transparent}
input[type="text"],input[type="number"],textarea{background:#0f1318;border:1px solid #2a3240;color:var(--text);border-radius:.6rem;padding:.55rem .6rem;outline:none}
textarea{min-height:84px;resize:vertical}
.muted{color:var(--muted)}

.wrap{max-width:960px;margin:0 auto;padding:12px}
.card{background:linear-gradient(180deg,#11151b,#0f1319);border:1px solid #1f2631;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
.list{display:flex;flex-direction:column}

.table-row{display:block;padding:12px 12px 6px;border-bottom:1px solid #1c2430;cursor:pointer}
.table-row:last-child{border-bottom:none}
.row-head{display:grid;grid-template-columns:minmax(120px,200px) 1fr max-content;gap:12px;align-items:center}
.badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;background:#152032;border:1px solid #243042;font-weight:700}
.ellip{min-width:0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:var(--muted);font-size:12px}
.stat{white-space:nowrap}
.bar{position:relative;height:14px;background:var(--bar-bg);border-radius:999px;overflow:hidden}
.bar .rem{position:absolute;inset:0 auto 0 0;background:var(--bar-rem)}
.bar .used{position:absolute;inset:0 0 0 auto;background:var(--bar-used)}

.table-row.open{background:#0e1319}
.expander{display:none;margin-top:10px;padding:12px;border:1px solid #243042;border-radius:10px;background:#0f1318}
.table-row.open .expander{display:block}

.field-2{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.field{margin:.6rem 0}
.actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.chips{display:flex;gap:.4rem;flex-wrap:wrap}
.chip .x{margin-left:.35rem;opacity:.7;font-weight:700;cursor:pointer}

.inv{border-top:1px solid #202632;margin-top:8px;padding-top:8px;max-height:260px;overflow:auto}
.inv-card{display:flex;gap:.6rem;align-items:center;border:1px solid #243042;border-radius:10px;padding:6px 8px;margin-bottom:8px}
.inv-thumb{width:56px;height:42px;flex:0 0 56px;background:#0f1318;border:1px solid #2a3240;border-radius:8px;overflow:hidden;display:grid;place-items:center}
.inv-thumb img{width:100%;height:100%;object-fit:cover}
.tag{display:inline-block;background:#152032;border:1px solid #243042;padding:.1rem .4rem;border-radius:999px;font-weight:600}

@media (max-width: 900px){
  .table-row{min-height:68px}
  .row-head{grid-template-columns: minmax(100px,160px) 1fr max-content}
}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="addTable" class="btn">Add Table</button>
    <button id="addPair" class="btn">Add Pair</button>
    <input id="q" type="text" placeholder="Search item / table / note / tag…" />
    <input id="need" type="number" min="0" step="1" style="width:120px" placeholder="Required space" />
    <button id="find" class="btn ghost">Find</button>
    <button id="clear" class="btn ghost">Clear</button>
    <span class="muted">Green = remaining space</span>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div id="tableList" class="list"></div>
  </div>
</main>

<script>
(function(){
  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const list = $('#tableList');
  const stateKey='bar.inv.inline.v2';

  let data = load() || seed();
  let openId = null;

  renderList();
  bindToolbar();

  function uid(){ return 't'+Math.random().toString(36).slice(2,9) }
  function eid(){ return 'e'+Math.random().toString(36).slice(2,9) }
  function newTable(name){ return {id:uid(), name, notes:'', tags:[], capacity:100, entries:[]}; }
  function remainingOf(t){ const used=(t.entries||[]).reduce((s,e)=>s+Number(e.size||0),0); return Math.max(0, Number(t.capacity||0)-used); }

  function seed(){
    const tables=[]; const isValid=n=>!/[47]/.test(String(n).padStart(2,'0'));
    for(let n=1;n<=88;n++){ if(!isValid(n)) continue; tables.push(newTable(`${n} Left`)); tables.push(newTable(`${n} Right`)); }
    return {tables};
  }

  function save(){ localStorage.setItem(stateKey, JSON.stringify(data)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(stateKey)) }catch{return null} }

  function renderList(items=data.tables){
    items=[...items].sort((a,b)=>remainingOf(b)-remainingOf(a));
    list.innerHTML='';
    if(!items.length){ list.innerHTML='<div class="table-row"><span class="muted">No tables</span></div>'; return; }

    items.forEach(t=>{
      const rem=remainingOf(t), cap=Number(t.capacity||0), pct=cap>0?(rem/cap)*100:0;
      const row=document.createElement('div');
      row.className='table-row';
      if(t.id===openId) row.classList.add('open');
      row.innerHTML=`
        <div class="row-head">
          <div class="meta">
            <span class="badge">${escape(t.name)}</span>
            <span class="ellip">${escape(t.entries?.[0]?.name||t.notes||'…')}</span>
          </div>
          <div class="bar"><div class="rem" style="width:${pct}%"></div></div>
          <div class="stat">${rem}/${cap}</div>
        </div>
        <div class="expander"></div>`;
      row.querySelector('.row-head').onclick=()=>{
        if(openId===t.id){openId=null;renderList();return;}
        openId=t.id;renderList();
      };
      list.appendChild(row);
      if(t.id===openId) renderRowEditor(t,row.querySelector('.expander'));
    });
  }

  function renderRowEditor(t,box){
    const rem=remainingOf(t), cap=Number(t.capacity||0);
    box.innerHTML=`
      <div class="field-2">
        <label>Name<input class="in-name" type="text" value="${escapeAttr(t.name)}"></label>
        <div></div>
      </div>
      <div class="field-2">
        <label>Capacity<input class="in-cap" type="number" value="${cap}"></label>
        <label>Remaining<input class="in-rem" type="number" disabled value="${rem}"></label>
      </div>
      <div class="field"><label>Notes<textarea class="in-notes">${escape(t.notes)}</textarea></label></div>
      <div class="field"><label>Tags (Enter to add)<input class="tag-input" type="text"></label><div class="chips tag-box">${renderTagsHtml(t.tags)}</div></div>
      <hr>
      <strong>Add Item</strong>
      <div class="field-2">
        <label>Item Name<input class="i-name" type="text"></label>
        <label>Size<input class="i-size" type="number"></label>
      </div>
      <div class="field"><label>Note<input class="i-note" type="text"></label></div>
      <div class="actions"><button class="btn primary i-add">Save Item</button></div>
      <div class="field"><strong>Items</strong></div>
      <div class="inv i-list muted">None</div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary btn-save">Save Table</button>
        <button class="btn" style="background:#25161a;border-color:#4a2a32;color:#ff9aa9">Delete Table</button>
      </div>`;
    box.querySelector('.in-name').onchange=e=>{t.name=e.target.value.trim();save();renderList();}
    box.querySelector('.in-cap').onchange=e=>{t.capacity=Number(e.target.value)||0;save();renderList();}
    box.querySelector('.in-notes').onchange=e=>{t.notes=e.target.value;save();renderList();}
    const tagBox=box.querySelector('.tag-box');const tagInput=box.querySelector('.tag-input');
    tagInput.onkeydown=e=>{if(e.key==='Enter'&&e.target.value.trim()){t.tags.push(e.target.value.trim());e.target.value='';save();tagBox.innerHTML=renderTagsHtml(t.tags);bindTagDeletes(t,tagBox);renderList();}}
    bindTagDeletes(t,tagBox);
    box.querySelector('.i-add').onclick=()=>{
      const name=box.querySelector('.i-name').value.trim();
      const size=Number(box.querySelector('.i-size').value)||0;
      const note=box.querySelector('.i-note').value.trim();
      if(!name){alert('Item name required');return;}
      t.entries.unshift({id:eid(),name,size,note,addedAt:Date.now()});
      save();renderInvMiniList(t,box.querySelector('.i-list'));renderList();
    };
    renderInvMiniList(t,box.querySelector('.i-list'));
    box.querySelector('.btn-save').onclick=()=>{save();renderList();}
    box.querySelector('.actions .btn:last-child').onclick=()=>{
      if(!confirm(`Delete ${t.name}?`))return;
      data.tables=data.tables.filter(x=>x.id!==t.id);openId=null;save();renderList();
    }
  }

  function renderTagsHtml(tags){return tags&&tags.length?tags.map((t,i)=>`<span class="chip">${escape(t)}<span class="x" data-idx="${i}">×</span></span>`).join(' '):'<span class="muted">None</span>'}
  function bindTagDeletes(t,tagBox){tagBox.querySelectorAll('.x').forEach(x=>x.onclick=()=>{t.tags.splice(x.dataset.idx,1);save();tagBox.innerHTML=renderTagsHtml(t.tags);bindTagDeletes(t,tagBox);renderList();})}
  function renderInvMiniList(t,c){c.innerHTML='';if(!t.entries.length){c.textContent='None';c.classList.add('muted');return;}c.classList.remove('muted');t.entries.forEach(en=>{const row=document.createElement('div');row.className='inv-card';row.innerHTML=`<div><b>${escape(en.name)}</b> <span class="tag">Size ${en.size}</span><div class="muted">${escape(en.note||'')}</div></div><div class="sp"></div><button class="btn btn-del" style="background:#25161a;color:#ff9aa9">Delete</button>`;row.querySelector('.btn-del').onclick=()=>{t.entries=t.entries.filter(x=>x.id!==en.id);save();renderInvMiniList(t,c);renderList();};c.appendChild(row);})}
  function bindToolbar(){ $('#addTable').onclick=()=>{const t=newTable('Custom '+(data.tables.length+1));data.tables.unshift(t);openId=t.id;save();renderList();};$('#addPair').onclick=()=>{const n=nextAvailableNumber();if(n==null){alert('No valid numbers left');return;}const left=newTable(`${n} Left`),right=newTable(`${n} Right`);data.tables.unshift(right,left);openId=left.id;save();renderList();};$('#find').onclick=search;$('#q').onkeydown=e=>{if(e.key==='Enter')search()};$('#need').onkeydown=e=>{if(e.key==='Enter')search()};$('#clear').onclick=()=>{$('#q').value='';$('#need').value='';openId=null;renderList();}}
  function search(){const kw=$('#q').value.trim().toLowerCase();const req=Number($('#need').value)||0;const out=data.tables.filter(t=>{const hit=!kw||(t.name||'').toLowerCase().includes(kw)||(t.notes||'').toLowerCase().includes(kw)||(t.tags||[]).some(x=>x.toLowerCase().includes(kw))||(t.entries||[]).some(en=>(en.name||'').toLowerCase().includes(kw)||(en.note||'').toLowerCase().includes(kw));const space=isNaN(req)||req<=0||remainingOf(t)>=req;return hit&&space;});openId=null;renderList(out);}
  function escape(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
  function escapeAttr(s){return escape(s).replace(/"/g,'&quot;')}
  function parseNumberAndSide(name){const m=String(name||'').match(/^(\d{1,2})\s+(left|right)$/i);return m?{num:+m[1],side:m[2].toLowerCase()}:null}
  function isValidNumber(n){return n>=1&&n<=88&&!/[47]/.test(String(n).padStart(2,'0'))}
  function nextAvailableNumber(){const used=new Map();for(const t of data.tables){const p=parseNumberAndSide(t.name);if(!p||!isValidNumber(p.num))continue;if(!used.has(p.num))used.set(p.num,new Set());used.get(p.num).add(p.side);}for(let n=1;n<=88;n++){if(!isValidNumber(n))continue;const s=used.get(n);if(!s||s.size<2)return n;}return null}
})();
</script>
</body>
</html>
